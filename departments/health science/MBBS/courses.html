<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedGlass Cloud - Course Management</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
 <link rel="stylesheet" href="sidebar.css">
 <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* CSS variables for theme (unused placeholders for primary/secondary/thememode) */
:root {
    --color-primary: #6366f1; /* indigo-500 */
    --color-secondary: #8b5cf6; /* violet-500 */
    --theme-mode: dark;
    --bg-primary: #0f172a; /* slate-900 */
    --text-primary: #e2e8f0; /* slate-200 */
    --text-muted: #94a3b8; /* slate-400 */
    --glass-bg: rgba(15, 23, 42, 0.5);
    --glass-border: rgba(255, 255, 255, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
}

/* Glass panel styles */
.glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: all 0.4s ease;
    border-radius: 16px;
}

.glass-card:hover {
    background: rgba(15, 23, 42, 0.8);
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
}

/* Animated gradient border */
.gradient-border {
    position: relative;
    z-index: 1;
}

.gradient-border::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    /* background: linear-gradient(45deg, var(--color-primary), var(--color-secondary), #ec4899); */
    z-index: -1;
    border-radius: 18px;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.glass-card:hover .gradient-border::before {
    opacity: 1;
}

/* Modal styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: rgba(15, 23, 42, 0.9);
    border-radius: 16px;
    padding: 2rem;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: modalEnter 0.3s ease-out;
}

@keyframes modalEnter {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Class image styling */
.class-img {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
}

.class-img::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(147, 51, 234, 0.1));
    z-index: 1;
}

.class-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
}

.glass-card:hover .class-img img {
    transform: scale(1.05);
}

/* Bubble animation container */
.bubble-container {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -1;
    overflow: hidden;
}

.bubble {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.1), rgba(147, 51, 234, 0.05));
    backdrop-filter: blur(1px);
    animation: float 20s infinite ease-in-out;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0) translateX(0) scale(1);
    }
    33% {
        transform: translateY(-100px) translateX(50px) scale(1.1);
    }
    66% {
        transform: translateY(50px) translateX(-50px) scale(0.9);
    }
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(99, 102, 241, 0.1);
}

::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
}

/* Animation classes */
.animate-slide-up {
    animation: slideInUp 0.6s ease forwards;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Pulse animation */
@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Form styles */
.form-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    color: white;
    transition: all 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: rgba(99, 102, 241, 0.5);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: #94a3b8;
}

.form-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    color: white;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1em;
}

.form-select:focus {
    outline: none;
    border-color: rgba(99, 102, 241, 0.5);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .glass-card {
        margin: 0 10px;
    }
    
    .class-img {
        height: 200px;
    }
}

/* Course card enhancements */
.course-badge {
    font-size: 0.7rem;
    letter-spacing: 0.02em;
}

.progress-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    border-radius: 3px;
    transition: width 0.8s ease;
}
   </style>
</head>
<body class="min-h-screen overflow-x-hidden">
    <!-- Animated Background -->
    <div class="bubble-container"></div>
    <div id="sidebar-root"></div>
    <script src="sidebar.js"></script>

    <!-- Header -->
    <header class="px-6 py-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <button id="backBtn" class="glass-card p-2 rounded-lg hover:bg-gray-700 transition-colors">
                            <i data-feather="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <h1 class="text-3xl md:text-4xl font-bold text-white">
                            <span class="bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                                MedGlass Cloud
                            </span>
                        </h1>
                    </div>
                    <p class="text-gray-400">Course Management Portal</p>
                </div>
                <div class="flex items-center gap-4">
                    <button class="glass-card px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-500/10 transition-all">
                        <i data-feather="bell"></i>
                        <span class="hidden sm:block">Notifications</span>
                    </button>
                    <div class="glass-card p-2 rounded-full">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-400 to-purple-400 flex items-center justify-center text-white font-bold">
                            DR
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 pb-12">
        <!-- Quick Stats and Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="glass-card gradient-border p-6 animate-slide-up" style="animation-delay: 0.1s">
                <h2 class="text-lg font-semibold mb-4">Course Overview</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Total Courses</span>
                        <span id="totalCourses" class="text-2xl font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Avg Credits/Sem</span>
                        <span id="avgCredits" class="text-2xl font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Instructors</span>
                        <span id="instructorCount" class="text-2xl font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Active This Semester</span>
                        <span id="activeCount" class="text-2xl font-bold">0</span>
                    </div>
                </div>
            </div>

            <div class="glass-card gradient-border p-6 lg:col-span-2 animate-slide-up" style="animation-delay: 0.2s">
                <h2 class="text-lg font-semibold mb-4">Credits Distribution</h2>
                <div class="h-48">
                    <canvas id="creditsChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Class Card -->
        <div id="classCard" class="glass-card gradient-border p-6 mb-8 animate-slide-up" style="animation-delay: 0.3s">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="class-img w-32 h-32 md:w-40 md:h-40">
                    <img id="classImage" src="" alt="Class Image" />
                </div>
                <div class="flex-1">
                    <h2 id="className" class="text-2xl font-bold">Loading Class...</h2>
                    <p id="classMeta" class="text-indigo-400 mb-4">Please wait</p>
                    <div class="flex flex-wrap gap-2">
                        <span id="classTypeBadge" class="px-3 py-1 bg-indigo-500/20 text-indigo-300 rounded-full text-xs">Loading</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Management -->
        <div class="glass-card gradient-border p-6 mb-8 animate-slide-up" style="animation-delay: 0.4s">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                <h2 class="text-xl font-bold">Courses</h2>
                <button id="addCourseBtn" class="glass-card px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium hover:opacity-90 transition-opacity flex items-center gap-2">
                    <i data-feather="plus" class="w-4 h-4"></i>
                    Add Course
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                <div class="relative">
                    <input type="text" id="searchInput" class="form-input pl-10" placeholder="Search courses..." />
                    <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <select id="instructorFilter" class="form-select">
                        <option value="">All Instructors</option>
                    </select>
                </div>
                <div class="relative">
                    <select id="creditFilter" class="form-select">
                        <option value="">All Credits</option>
                        <option value="1">1 Credit</option>
                        <option value="2">2 Credits</option>
                        <option value="3">3 Credits</option>
                        <option value="4">4 Credits</option>
                        <option value="5">5+ Credits</option>
                    </select>
                </div>
            </div>

            <!-- Course Cards Grid -->
            <div id="coursesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Courses will be dynamically inserted here -->
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center items-center mt-8 gap-2">
                <!-- Pagination buttons will be dynamically inserted -->
            </div>
        </div>
    </main>

    <!-- Add/Edit Course Modal -->
    <div id="courseModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-bold">Add Course</h2>
                <button id="closeCourseModalBtn" class="glass-card p-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i data-feather="x"></i>
                </button>
            </div>

            <form id="courseForm" class="space-y-4">
                <div>
                    <label for="courseName" class="form-label">Course Name</label>
                    <input type="text" id="courseName" class="form-input" placeholder="e.g. Human Anatomy" required>
                </div>

                <div>
                    <label for="courseCode" class="form-label">Course Code</label>
                    <input type="text" id="courseCode" class="form-input" placeholder="e.g. ANAT-301" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="instructor" class="form-label">Instructor</label>
                        <input type="text" id="instructor" class="form-input" placeholder="e.g. Dr. Smith" required>
                    </div>
                    <div>
                        <label for="credits" class="form-label">Credits</label>
                        <input type="number" id="credits" class="form-input" min="1" max="10" placeholder="e.g. 3" required>
                    </div>
                </div>

                <div>
                    <label for="schedule" class="form-label">Schedule</label>
                    <input type="text" id="schedule" class="form-input" placeholder="e.g. Mon/Wed 9-11 AM" required>
                </div>

                <div>
                    <label for="classroom" class="form-label">Classroom</label>
                    <input type="text" id="classroom" class="form-input" placeholder="e.g. Lab A">
                </div>

                <div>
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" class="form-input" rows="3" placeholder="Brief course description"></textarea>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="submit" class="flex-1 glass-card py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                        <i data-feather="save" class="w-4 h-4"></i>
                        <span id="submitBtnText">Save Course</span>
                    </button>
                    <button type="button" id="cancelBtn" class="glass-card px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

   <script>
    // Firebase config (using the same project from your existing app)
// ==============================================
// Courses Management - Connected to Class Context
// ==============================================

// Firebase config (match your existing project)
const firebaseConfig = {
    apiKey: "AIzaSyCPV_mXojZBR-Dew8RuZSi9jv9X6rc_D90",
    authDomain: "mentora-71f5c.firebaseapp.com",
    projectId: "mentora-71f5c",
    storageBucket: "mentora-71f5c.appspot.com",
    messagingSenderId: "16685388211",
    appId: "1:16685388211:web:7eed812660439dec7b3bc6",
    measurementId: "G-BL98PXGK2G"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global state
let courses = [];
let filteredCourses = [];
let classId = new URLSearchParams(window.location.search).get('classId') || new URLSearchParams(window.location.search).get('id');
let currentClass = null; // Will hold the class document for context

// Chart instance
let chartInstance = null;

// Course object structure
// {
//   id, classId, name, code, instructor, credits, schedule, classroom,
//   description, active: true, createdAt, updatedAt
// }

// ==============================================
// DOM references
// ==============================================
const backBtn = document.getElementById('backBtn');
const addCourseBtn = document.getElementById('addCourseBtn');
const closeCourseModalBtn = document.getElementById('closeCourseModalBtn');
const courseModal = document.getElementById('courseModal');
const courseForm = document.getElementById('courseForm');
const coursesContainer = document.getElementById('coursesContainer');
const searchInput = document.getElementById('searchInput');
const instructorFilter = document.getElementById('instructorFilter');
const creditFilter = document.getElementById('creditFilter');
const cancelBtn = document.getElementById('cancelBtn');

const modalTitle = document.getElementById('modalTitle');
const submitBtnText = document.getElementById('submitBtnText');

// Form fields
const courseName = document.getElementById('courseName');
const courseCode = document.getElementById('courseCode');
const instructor = document.getElementById('instructor');
const credits = document.getElementById('credits');
const schedule = document.getElementById('schedule');
const classroom = document.getElementById('classroom');
const description = document.getElementById('description');

// Header elements
const classNameEl = document.getElementById('className');
const classMetaEl = document.getElementById('classMeta');
const classTypeBadge = document.getElementById('classTypeBadge');
const classImage = document.getElementById('classImage');

// Stats elements
const totalCoursesEl = document.getElementById('totalCourses');
const avgCreditsEl = document.getElementById('avgCredits');
const instructorCountEl = document.getElementById('instructorCount');
const activeCountEl = document.getElementById('activeCount');

// Editing state
let editingCourseId = null;

// ==============================================
// Utilities
// ==============================================
const debounce = (fn, delay = 300) => {
    let t;
    return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
    };
};

// Escape HTML
function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
}

// Background bubbles
function createBubbles() {
    const container = document.querySelector('.bubble-container');
    if (!container) return;

    const bubbleCount = 18;
    for (let i = 0; i < bubbleCount; i++) {
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const size = Math.random() * 120 + 40;
        const left = Math.random() * 100;
        const top = Math.random() * 100;
        const delay = Math.random() * 10;

        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${left}%`;
        bubble.style.top = `${top}%`;
        bubble.style.animationDelay = `${delay}s`;

        container.appendChild(bubble);
    }
}

// Color helper for class type badge
function colorForType(type) {
    switch (type) {
        case 'YEAR 1': return 'bg-indigo-500/20 text-indigo-300';
        case 'YEAR 2': return 'bg-emerald-500/20 text-emerald-300';
        case 'YEAR 3': return 'bg-purple-500/20 text-purple-300';
        case 'YEAR 4': return 'bg-rose-500/20 text-rose-300';
        case 'YEAR 5': return 'bg-amber-500/20 text-amber-300';
        case 'YEAR 6': return 'bg-amber-500/20 text-amber-300';
        default: return 'bg-slate-500/20 text-slate-300';
    }
}

// ==============================================
// Class context
// ==============================================

// Load class info from Firestore (sets currentClass)
function loadClassInfo() {
    if (!classId) {
        console.warn('No classId provided in URL. Courses will run in demo mode.');
        // Set some fallback UI state
        classNameEl.textContent = 'Unknown Class';
        classMetaEl.textContent = 'No context';
        classTypeBadge.textContent = 'N/A';
        classTypeBadge.className = 'px-3 py-1 rounded-full text-xs bg-slate-500/20 text-slate-300';
        classImage.src = 'http://static.photos/education/640x360/5';
        return;
    }

    db.collection('classes').doc(classId).get()
        .then(doc => {
            if (doc.exists) {
                currentClass = { id: doc.id, ...doc.data() };
                classNameEl.textContent = currentClass.name || `Class ${classId}`;
                classMetaEl.textContent = `${currentClass.year || 'Year ?'} • ${currentClass.semester || 'Semester ?'} • ${currentClass.schedule || 'No schedule'}`;
                classTypeBadge.textContent = currentClass.type || 'COURSE';
                classTypeBadge.className = `px-3 py-1 rounded-full text-xs ${colorForType(currentClass.type)}`;
                classImage.src = currentClass.image || 'http://static.photos/education/640x360/5';
            } else {
                currentClass = null;
                classNameEl.textContent = `Class ${classId}`;
                classMetaEl.textContent = 'Unknown Class';
                classTypeBadge.textContent = 'N/A';
                classTypeBadge.className = 'px-3 py-1 rounded-full text-xs bg-slate-500/20 text-slate-300';
                console.warn('Class not found for id:', classId);
            }
        })
        .catch(err => {
            console.error('Error loading class:', err);
        });
}

// ==============================================
// Courses CRUD
// ==============================================

// Create course card HTML
function createCourseCard(course) {
    const typeColor = colorForType(currentClass?.type || 'COURSE');
    const progress = Math.min(Math.max((course.credits || 0) * 10, 10), 100);

    return `
        <div class="glass-card gradient-border p-0 overflow-hidden" data-id="${course.id}">
            <div class="p-6">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-lg font-bold leading-tight">${escapeHtml(course.name)}</h3>
                        <p class="text-sm text-gray-400">${escapeHtml(course.code)}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-xs ${typeColor} course-badge">${course.active !== false ? 'Active' : 'Inactive'}</span>
                </div>

                <div class="space-y-2 mb-4">
                    <div class="flex items-center gap-2 text-sm">
                        <i data-feather="user" class="text-emerald-400 w-4 h-4"></i>
                        <span>${escapeHtml(course.instructor)}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <i data-feather="clock" class="text-amber-400 w-4 h-4"></i>
                        <span>${course.schedule ? escapeHtml(course.schedule) : 'TBA'}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <i data-feather="map-pin" class="text-rose-400 w-4 h-4"></i>
                        <span>${course.classroom ? escapeHtml(course.classroom) : 'TBA'}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <i data-feather="book-open" class="text-indigo-400 w-4 h-4"></i>
                        <span>${course.credits || 0} Credits</span>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs text-gray-400">Course Progress</span>
                        <span class="text-xs text-gray-400">${progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>

                <p class="text-xs text-gray-400 mb-4 line-clamp-2">${escapeHtml(course.description || 'No description provided.')}</p>

                <div class="flex gap-2">
                    <button class="edit-course-btn flex-1 glass-card py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2" data-id="${course.id}">
                        <i data-feather="edit-2" class="w-4 h-4"></i>
                        Edit
                    </button>
                    <button class="delete-course-btn glass-card p-2 rounded-lg hover:bg-rose-500/20 transition-colors" data-id="${course.id}">
                        <i data-feather="trash-2" class="w-4 h-4 text-rose-400"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Load courses from Firestore (scoped to current class)
function loadCourses() {
    if (!classId) {
        // Demo mode fallback
        courses = [];
        filteredCourses = [];
        renderCourses();
        updateFilters();
        updateStats();
        feather.replace();
        return;
    }

    db.collection('courses')
        .where('classId', '==', classId)
        .orderBy('createdAt', 'desc')
        .get()
        .then(snapshot => {
            courses = [];
            snapshot.forEach(doc => {
                courses.push({ id: doc.id, ...doc.data() });
            });
            filteredCourses = [...courses];
            renderCourses();
            updateFilters();
            updateStats();
            feather.replace();
        })
        .catch(err => {
            console.error('Error loading courses:', err);
        });
}

// Update filters (instructor dropdown)
function updateFilters() {
    const instructors = [...new Set(courses.map(c => c.instructor).filter(Boolean))].sort();
    instructorFilter.innerHTML = '<option value="">All Instructors</option>' + instructors.map(i => `<option value="${escapeHtml(i)}">${escapeHtml(i)}</option>`).join('');
}

// Apply filters
function applyFilters() {
    const query = (searchInput.value || '').toLowerCase().trim();
    const selectedInstructor = instructorFilter.value;
    const selectedCredits = creditFilter.value;

    filteredCourses = courses.filter(course => {
        const matchesQuery = !query ||
            course.name.toLowerCase().includes(query) ||
            course.code.toLowerCase().includes(query) ||
            course.instructor.toLowerCase().includes(query);
        const matchesInstructor = !selectedInstructor || course.instructor === selectedInstructor;
        const matchesCredits = !selectedCredits ||
            (selectedCredits === '5' ? (course.credits >= 5) : (course.credits === parseInt(selectedCredits)));
        return matchesQuery && matchesInstructor && matchesCredits;
    });

    renderCourses();
}

// Render courses grid
function renderCourses() {
    if (filteredCourses.length === 0) {
        coursesContainer.innerHTML = `
            <div class="glass-card p-8 text-center col-span-3">
                <i data-feather="alert-circle" class="w-12 h-12 text-rose-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-bold mb-2">No Courses Found</h3>
                <p class="text-gray-400 mb-4">${courses.length === 0 ? 'Add a course to get started' : 'Try adjusting your filters'}</p>
                <button id="emptyAddBtn" class="glass-card px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium hover:opacity-90 transition-opacity flex items-center gap-2 mx-auto">
                    <i data-feather="plus" class="w-4 h-4"></i>
                    Add Course
                </button>
            </div>
        `;
        feather.replace();
        const emptyAddBtn = document.getElementById('emptyAddBtn');
        if (emptyAddBtn) emptyAddBtn.addEventListener('click', () => { openModal(); });
        return;
    }

    coursesContainer.innerHTML = filteredCourses.map(createCourseCard).join('');
    feather.replace();

    // Simple fade-in animation (without external libs)
    const cards = coursesContainer.querySelectorAll('.glass-card.gradient-border');
    cards.forEach((card, idx) => {
        card.style.opacity = 0;
        card.style.transform = 'translateY(12px)';
        setTimeout(() => {
            card.style.transition = 'all 300ms ease';
            card.style.opacity = 1;
            card.style.transform = 'translateY(0)';
        }, idx * 50);
    });
}

// ==============================================
// Stats + Chart
// ==============================================

// Update stats and chart
function updateStats() {
    const total = courses.length;
    const avg = total ? (courses.reduce((sum, c) => sum + (c.credits || 0), 0) / total) : 0;
    const instructors = new Set(courses.map(c => c.instructor).filter(Boolean)).size;
    const active = courses.filter(c => c.active !== false).length;

    totalCoursesEl.textContent = total;
    avgCreditsEl.textContent = avg.toFixed(1);
    instructorCountEl.textContent = instructors;
    activeCountEl.textContent = active;

    // Chart data
    const buckets = { 1: 0, 2: 0, 3: 0, 4: 0, '5+': 0 };
    courses.forEach(c => {
        const credit = c.credits || 0;
        if (credit >= 5) buckets['5+']++;
        else buckets[credit] = (buckets[credit] || 0) + 1;
    });

    updateChart([buckets[1], buckets[2], buckets[3], buckets[4], buckets['5+']]);
}

// Update Chart.js
function updateChart(data) {
    const ctx = document.getElementById('creditsChart')?.getContext('2d');
    if (!ctx) return;

    if (chartInstance) {
        chartInstance.data.datasets[0].data = data;
        chartInstance.update();
        return;
    }

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['1 Credit', '2 Credits', '3 Credits', '4 Credits', '5+ Credits'],
            datasets: [{
                data,
                backgroundColor: [
                    'rgba(99, 102, 241, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(236, 72, 153, 0.8)',
                    'rgba(251, 146, 60, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                ],
                borderColor: 'rgba(255,255,255,0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e2e8f0',
                        padding: 15
                    }
                }
            },
            cutout: '65%'
        }
    });
}

// ==============================================
// Modal handlers
// ==============================================

function openModal() {
    courseModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    courseModal.classList.add('hidden');
    document.body.style.overflow = '';
    courseForm.reset();
    editingCourseId = null;
    modalTitle.textContent = 'Add Course';
    submitBtnText.textContent = 'Save Course';
}

// ==============================================
// Event handlers
// ==============================================

// Search + Filters
searchInput.addEventListener('input', debounce(applyFilters, 250));
instructorFilter.addEventListener('change', applyFilters);
creditFilter.addEventListener('change', applyFilters);

// Event delegation for edit/delete
coursesContainer.addEventListener('click', (e) => {
    const editBtn = e.target.closest('.edit-course-btn');
    const deleteBtn = e.target.closest('.delete-course-btn');

    if (editBtn) {
        const id = editBtn.dataset.id;
        const course = courses.find(c => c.id === id);
        if (course) {
            editingCourseId = id;
            modalTitle.textContent = 'Edit Course';
            submitBtnText.textContent = 'Update Course';
            courseName.value = course.name || '';
            courseCode.value = course.code || '';
            instructor.value = course.instructor || '';
            credits.value = course.credits || 1;
            schedule.value = course.schedule || '';
            classroom.value = course.classroom || '';
            description.value = course.description || '';
            openModal();
        }
    }

    if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        const course = courses.find(c => c.id === id);
        if (course && confirm(`Delete "${course.name}"? This cannot be undone.`)) {
            db.collection('courses').doc(id).delete()
                .then(() => loadCourses())
                .catch(err => console.error('Error deleting course:', err));
        }
    }
});

// Form submit
courseForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const data = {
        classId,
        name: courseName.value.trim(),
        code: courseCode.value.trim(),
        instructor: instructor.value.trim(),
        credits: parseInt(credits.value) || 1,
        schedule: schedule.value.trim(),
        classroom: classroom.value.trim(),
        description: description.value.trim(),
        active: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (!data.name || !data.code || !data.instructor) {
        alert('Please fill in required fields (Name, Code, Instructor).');
        return;
    }

    if (editingCourseId) {
        db.collection('courses').doc(editingCourseId).update(data)
            .then(() => {
                closeModal();
                loadCourses();
            })
            .catch(err => console.error('Error updating course:', err));
    } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        db.collection('courses').add(data)
            .then(() => {
                closeModal();
                loadCourses();
            })
            .catch(err => console.error('Error adding course:', err));
    }
});

// ==============================================
// Initialization
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
    createBubbles();
    feather.replace(); // Ensure feather icons are rendered
    loadClassInfo();
    loadCourses();

    // Back navigation (keep context)
    backBtn.addEventListener('click', () => {
        if (classId) {
            window.location.href = `students.html?id=${encodeURIComponent(classId)}`;
        } else {
            window.location.href = 'index.html';
        }
    });

    // Add course modal open/close
    addCourseBtn.addEventListener('click', () => {
        editingCourseId = null;
        modalTitle.textContent = 'Add Course';
        submitBtnText.textContent = 'Save Course';
        courseForm.reset();
        openModal();
    });

    closeCourseModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // Close modal on backdrop click
    courseModal.addEventListener('click', (e) => {
        if (e.target === courseModal) closeModal();
    });
});
   </script>
    <script>feather.replace();</script>
</body>
</html>