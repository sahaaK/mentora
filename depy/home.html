<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Management - Create & Manage Classes</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Sidebar (kept from your original) -->
    <link rel="stylesheet" href="components/sidebar.css">
    <script src="sidebar.js"></script>

    <style>
        /* Page-specific tweaks for the Classes page. Theme, particle background and global UI styles
           are provided by style.css (shared portal theme). Keep only class/program specific rules here. */

        /* Program filter cards (page-specific) */
        .program-filter {
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
            cursor: pointer;
        }
        .program-filter:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(84,119,255,0.22);
        }
        .program-filter.active {
            border-color: rgba(84,119,255,0.6);
            box-shadow: 0 0 30px rgba(84,119,255,0.28);
        }

        /* Class card tweaks (slight lift) */
        .class-card { transition: all 0.28s cubic-bezier(.2,.9,.3,1); }
        .class-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 24px 48px rgba(0,0,0,0.35); }

        /* Image upload area used in create class modal */
        .image-upload-area { border: 2px dashed rgba(255,255,255,0.12); transition: all .2s ease; }
        .image-upload-area:hover { border-color: rgba(139,92,246,0.5); background: rgba(139,92,246,0.03); }
        .image-upload-area.has-image { border-style: solid; border-color: rgba(139,92,246,0.5); }

        /* Small helper for subtle skeleton on this page (style.css has a general skeleton already) */
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.03) 20%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 80%); background-size: 200% 100%; animation: shimmer 1.6s infinite; }

        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #0f172a, #1e293b);
    color: #e2e8f0;
    overflow-x: hidden;
    min-height: 100vh;
}

/* Glass panel styles */
.glass-card {
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-radius: 20px;
    overflow: hidden;
}

.glass-card:hover {
    background: rgba(15, 23, 42, 0.8);
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
::-webkit-scrollbar-track {
    background: rgba(99, 102, 241, 0.1);
}
::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
}

/* Floating particles */
.particles-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
}

.particle {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.2), rgba(147, 51, 234, 0.1));
    backdrop-filter: blur(1px);
    animation: float 15s infinite ease-in-out;
    opacity: 0.7;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0) translateX(0) scale(1);
    }
    33% {
        transform: translateY(-80px) translateX(40px) scale(1.1);
    }
    66% {
        transform: translateY(40px) translateX(-40px) scale(0.9);
    }
}

/* Button styles */
.btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    opacity: 0.9;
}

/* Notification badge */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 18px;
    height: 18px;
    background: #ef4444;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    color: white;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Program card styles - Image Zoom with Overlay Panel */
.program-card {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    transition: all 0.5s ease;
}
.program-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 40px rgba(89, 111, 245, 0.25);
}
.program-image {
    transition: transform 0.7s ease;
}
.program-card:hover .program-image {
    transform: scale(1.1);
}
.overlay-shine {
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, transparent 30%, rgba(255, 255, 255, 0.06) 50%, transparent 70%);
    transform: translateX(-120%);
    transition: transform 0.8s ease;
    pointer-events: none;
}
.program-card:hover .overlay-shine {
    transform: translateX(120%);
}

/* Bubble background */
.bubble {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(89, 111, 245, 0.12), rgba(167, 139, 250, 0.06));
    backdrop-filter: blur(1px);
    animation: float 18s infinite ease-in-out;
    pointer-events: none;
}

/* Modal styles */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}
.modal-content {
    background: rgba(15, 23, 42, 0.9);
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: modalEnter 0.3s ease-out;
}
@keyframes modalEnter {
    from { opacity: 0; transform: translateY(20px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Loading skeleton */
.skeleton {
    background-color: rgba(255, 255, 255, 0.08);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
}
.skeleton::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.06), transparent);
    animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Form inputs */
.form-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    color: white;
    transition: all 0.3s ease;
}
.form-input:focus {
    outline: none;
    border-color: rgba(89, 111, 245, 0.5);
    box-shadow: 0 0 0 2px rgba(89, 111, 245, 0.2);
}
.form-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    color: white;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .glass-card {
        margin: 0 10px;
    }
}
    </style>
</head>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'undefined-50':  '#f3f6ff',
                    'undefined-100': '#e6edff',
                    'undefined-200': '#d0dcff',
                    'undefined-300': '#a9bfff',
                    'undefined-400': '#7d9cff',
                    'undefined-500': '#5477ff',
                    'undefined-600': '#3b5ef0',
                    'undefined-700': '#2d48bf',
                    'undefined-800': '#243a97',
                    'undefined-900': '#1e317a',
                    'undefined-950': '#171f4d'
                },
                boxShadow: {
                    'glass': '0 10px 40px rgba(0,0,0,0.25)',
                    'glow': '0 0 30px rgba(139,92,246,0.3)',
                },
                keyframes: {
                    'fade-in': { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                    'scale-in': { '0%': { opacity: 0, transform: 'scale(.95)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
                    'pop': { '0%': { transform: 'scale(.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                    'slide-up': { '0%': { transform: 'translateY(12px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                },
                animation: {
                    'fade-in': 'fade-in .2s ease-out',
                    'scale-in': 'scale-in .24s cubic-bezier(.2,.9,.3,1)',
                    'pop': 'pop .18s ease-out',
                    'slide-up': 'slide-up .28s ease-out',
                }
            }
        }
    }
</script>

<body class="min-h-screen overflow-x-hidden">
    <!-- Floating Particles -->
    <div class="particles-container"></div>

    <!-- Sidebar -->
    <div id="sidebar-root"></div>

    <!-- Main Content Container -->
    <div class="ml-0 md:ml-74 transition-all duration-300">
        <!-- Header -->
        <header class="px-6 py-6 animate__animated animate__fadeIn">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white">
                            <span class="bg-gradient-to-r from-undefined-400 to-purple-400 bg-clip-text text-transparent">
                                Class Management
                            </span>
                        </h1>
                        <p class="text-gray-400 text-sm">Create and manage classes for your programs</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="openAddClassModal" class="group relative inline-flex items-center gap-3 px-6 py-3.5 rounded-xl text-white font-semibold bg-gradient-to-br from-undefined-500 to-purple-600 hover:from-undefined-600 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-undefined-500/30 transition-all duration-200 shadow-lg hover:shadow-undefined-500/30 animate__animated animate__fadeIn animate__delay-1s">
                            <span class="absolute inset-0 rounded-xl bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></span>
                            <i data-feather="plus-circle" class="w-5 h-5"></i>
                            <span>Create Class</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-6 pb-12">
            <!-- Layout: Programs column + Analytics (charts) -->
            <section class="mb-8 animate__animated animate__fadeInUp">
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                    <!-- Programs Column -->
                    <div class="xl:col-span-4">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-feather="filter" class="text-undefined-400"></i>
                            Select Program
                        </h2>
                        <div id="programsFilter" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-1 gap-4">
                            <!-- Loading skeletons -->
                            <div class="glass-card rounded-xl p-4 skeleton h-32"></div>
                            <div class="glass-card rounded-xl p-4 skeleton h-32"></div>
                            <div class="glass-card rounded-xl p-4 skeleton h-32"></div>
                            <div class="glass-card rounded-xl p-4 skeleton h-32"></div>
                        </div>
                    </div>

                    <!-- Analytics / Charts Column -->
                    <div class="xl:col-span-8">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-feather="bar-chart-2" class="text-undefined-400"></i>
                            Analytics
                        </h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Classes by Year Chart -->
                            <div class="glass-card rounded-2xl p-6 border border-white/10">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Classes by Year</h3>
                                        <p class="text-sm text-gray-400">Distribution across academic years</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-lg bg-undefined-500/20 flex items-center justify-center">
                                        <i data-feather="calendar" class="w-5 h-5 text-undefined-400"></i>
                                    </div>
                                </div>
                                <div class="relative">
                                    <canvas id="classesByYearChart" height="180"></canvas>
                                    <div id="classesByYearEmpty" class="hidden absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <i data-feather="calendar" class="w-12 h-12 text-gray-500 mx-auto mb-2"></i>
                                            <p class="text-gray-400 text-sm">No data available</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Program Distribution Chart -->
                            <div class="glass-card rounded-2xl p-6 border border-white/10">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Program Distribution</h3>
                                        <p class="text-sm text-gray-400">Classes per program</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-lg bg-undefined-500/20 flex items-center justify-center">
                                        <i data-feather="pie-chart" class="w-5 h-5 text-undefined-400"></i>
                                    </div>
                                </div>
                                <div class="relative">
                                    <canvas id="programDistributionChart" height="180"></canvas>
                                    <div id="programDistributionEmpty" class="hidden absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <i data-feather="pie-chart" class="w-12 h-12 text-gray-500 mx-auto mb-2"></i>
                                            <p class="text-gray-400 text-sm">No data available</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Classes Display Section -->
            <section class="animate__animated animate__fadeIn animate__delay-1s">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-feather="book-open" class="text-undefined-400"></i>
                        <span id="selectedProgramName">All Classes</span>
                    </h2>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <input type="text" id="classSearch" placeholder="Search classes..." 
                                   class="glass-card px-4 py-2 pl-10 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-undefined-500/50 w-64">
                            <i data-feather="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                        </div>
                        <select id="yearFilter" class="glass-card px-4 py-2 rounded-lg text-white bg-transparent focus:outline-none focus:ring-2 focus:ring-undefined-500/50">
                            <option value="">All Years</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="4">Year 4</option>
                            <option value="5">Year 5</option>
                        </select>
                    </div>
                </div>

                <!-- Classes Grid -->
                <div id="classesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Initial state or empty state -->
                    <div class="glass-card rounded-2xl p-8 text-center col-span-full">
                        <i data-feather="book" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-300 mb-2">No Classes Yet</h3>
                        <p class="text-gray-400 mb-4">Select a program to view classes or create your first class</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Class Modal -->
    <div id="addClassModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-300">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAddClassModal()"></div>
        <div class="relative w-full max-w-2xl glass-card rounded-2xl shadow-2xl border border-white/10 transform scale-95 transition-transform duration-300">
            <!-- Modal Header -->
            <div class="px-6 py-5 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-white">Create New Class</h1>
                    <p class="text-gray-400 text-sm">Add a new class to your program</p>
                </div>
                <button onclick="closeAddClassModal()" class="glass-card p-2 rounded-lg hover:bg-undefined-500/10 transition-all">
                    <i data-feather="x" class="w-5 h-5 text-gray-300"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <form id="createClassForm" class="p-6 space-y-6">
                <!-- Program Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-feather="archive" class="inline w-4 h-4 mr-1"></i>
                        Select Program <span class="text-red-400">*</span>
                    </label>
                    <select id="programSelect" class="w-full glass-card px-4 py-3 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-undefined-500/50" required>
                        <option value="">Choose a program...</option>
                    </select>
                </div>

                <!-- Year Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-feather="calendar" class="inline w-4 h-4 mr-1"></i>
                        Academic Year <span class="text-red-400">*</span>
                    </label>
                    <select id="yearSelect" class="w-full glass-card px-4 py-3 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-undefined-500/50" required>
                        <option value="">Select year...</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                        <option value="5">Year 5</option>
                    </select>
                </div>

                <!-- Max Capacity -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-feather="users" class="inline w-4 h-4 mr-1"></i>
                        Maximum Capacity <span class="text-red-400">*</span>
                    </label>
                    <input type="number" id="capacityInput" min="1" max="500" placeholder="Enter maximum number of students" 
                           class="w-full glass-card px-4 py-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-undefined-500/50" required>
                </div>

                <!-- Class Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-feather="edit-3" class="inline w-4 h-4 mr-1"></i>
                        Class Name <span class="text-red-400">*</span>
                    </label>
                    <input type="text" id="classNameInput" placeholder="e.g., Advanced Mathematics, Physics Lab" 
                           class="w-full glass-card px-4 py-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-undefined-500/50" required>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-feather="file-text" class="inline w-4 h-4 mr-1"></i>
                        Description (Optional)
                    </label>
                    <textarea id="classDescription" rows="3" placeholder="Brief description of the class..." 
                              class="w-full glass-card px-4 py-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-undefined-500/50"></textarea>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-feather="image" class="inline w-4 h-4 mr-1"></i>
                        Thumbnail Image (Optional)
                    </label>
                    <div class="flex gap-4">
                        <div id="imageUploadArea" class="image-upload-area flex-1 glass-card rounded-xl p-8 text-center cursor-pointer">
                            <i data-feather="upload-cloud" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                            <p class="text-gray-400 text-sm">Click to upload or drag and drop</p>
                            <p class="text-gray-500 text-xs mt-1">PNG, JPG up to 10MB</p>
                            <input type="file" id="imageInput" accept="image/*" class="hidden">
                        </div>
                        <div class="flex flex-col gap-2">
                            <button type="button" onclick="generateRandomImage()" class="glass-card px-4 py-2 rounded-lg text-undefined-400 hover:bg-undefined-500/10 transition-all text-sm">
                                <i data-feather="shuffle" class="inline w-4 h-4 mr-1"></i>
                                Random
                            </button>
                            <button type="button" onclick="clearImage()" class="glass-card px-4 py-2 rounded-lg text-gray-400 hover:bg-red-500/10 transition-all text-sm">
                                <i data-feather="x-circle" class="inline w-4 h-4 mr-1"></i>
                                Clear
                            </button>
                        </div>
                    </div>
                    <div id="imagePreview" class="mt-4 hidden">
                        <img src="" alt="Preview" class="w-full h-48 object-cover rounded-xl">
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-4 pt-4 border-t border-white/10">
                    <button type="button" onclick="closeAddClassModal()" class="px-6 py-3 rounded-lg glass-card text-gray-300 hover:text-white transition-all">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 rounded-lg bg-gradient-to-r from-undefined-500 to-purple-600 text-white font-semibold hover:from-undefined-600 hover:to-purple-700 transition-all flex items-center gap-2">
                        <i data-feather="save" class="w-5 h-5"></i>
                        Create Class
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed bottom-8 right-8 glass-card rounded-xl px-6 py-4 flex items-center gap-3 transform translate-x-full transition-transform duration-300 z-50">
        <div class="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center">
            <i data-feather="check-circle" class="w-6 h-6 text-emerald-400"></i>
        </div>
        <div>
            <h4 class="text-white font-semibold">Success!</h4>
            <p class="text-gray-400 text-sm">Class created successfully</p>
        </div>
    </div>

    <script>
// Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCPV_mXojZBR-Dew8RuZSi9jv9X6rc_D90",
    authDomain: "mentora-71f5c.firebaseapp.com",
    projectId: "mentora-71f5c",
    storageBucket: "mentora-71f5c.appspot.com",
    messagingSenderId: "16685388211",
    appId: "1:16685388211:web:7eed812660439dec7b3bc6",
    measurementId: "G-BL98PXGK2G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Global variables
let programs = [];
let classes = [];
let selectedProgramId = null;
let selectedProgramName = 'All Classes';
let currentImageUrl = '';

// Charts
let classesByYearChart;
let programDistributionChart;

// Create floating particles
function createParticles() {
    const container = document.querySelector('.particles-container');
    const particleCount = 15;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        const size = Math.random() * 150 + 50;
        const left = Math.random() * 100;
        const delay = Math.random() * 20;
        const duration = Math.random() * 15 + 20;
        
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${left}%`;
        particle.style.animationDelay = `${delay}s`;
        particle.style.animationDuration = `${duration}s`;
        
        container.appendChild(particle);
    }
}

// Fetch programs from Firestore
async function fetchPrograms() {
    const deptId = localStorage.getItem('currentDeptId');
    if (!deptId) return;

    try {
        const snapshot = await db.collection('departments').doc(deptId).collection('programs').get();
        programs = [];
        
        snapshot.forEach((doc) => {
            programs.push({
                id: doc.id,
                ...doc.data()
            });
        });

        renderProgramFilters();
        populateProgramSelect();
        updateCharts();
    } catch (error) {
        console.error('Error fetching programs:', error);
    }
}

// Fetch classes
async function fetchClasses() {
    const deptId = localStorage.getItem('currentDeptId');
    if (!deptId) return;

    const container = document.getElementById('classesContainer');
    const searchTerm = document.getElementById('classSearch').value.toLowerCase();
    const yearFilter = document.getElementById('yearFilter').value;

    // Show loading state
    container.innerHTML = Array(3).fill(0).map(() => `
        <div class="glass-card rounded-2xl overflow-hidden animate-pulse">
            <div class="h-48 skeleton"></div>
            <div class="p-6 space-y-3">
                <div class="h-6 skeleton rounded w-3/4"></div>
                <div class="h-4 skeleton rounded w-full"></div>
                <div class="flex gap-2">
                    <div class="h-6 skeleton rounded-full w-16"></div>
                    <div class="h-6 skeleton rounded-full w-20"></div>
                </div>
            </div>
        </div>
    `).join('');

    try {
        let query = db.collection('departments').doc(deptId).collection('classes');
        
        if (selectedProgramId) {
            query = query.where('programId', '==', selectedProgramId);
        }
        
        const snapshot = await query.get();
        classes = [];
        
        snapshot.forEach((doc) => {
            classes.push({
                id: doc.id,
                ...doc.data()
            });
        });

        // Apply filters
        let filteredClasses = classes;
        if (searchTerm) {
            filteredClasses = filteredClasses.filter(c => 
                c.name?.toLowerCase().includes(searchTerm) ||
                c.description?.toLowerCase().includes(searchTerm)
            );
        }
        if (yearFilter) {
            filteredClasses = filteredClasses.filter(c => c.year == yearFilter);
        }

        renderClasses(filteredClasses);
        updateCharts();
    } catch (error) {
        console.error('Error fetching classes:', error);
        container.innerHTML = `
            <div class="glass-card rounded-2xl p-8 text-center col-span-full">
                <i data-feather="alert-circle" class="w-16 h-16 text-red-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-300 mb-2">Error Loading Classes</h3>
                <p class="text-gray-400">${error.message}</p>
            </div>
        `;
        feather.replace();
    }
}

// Render program filters
function renderProgramFilters() {
    const container = document.getElementById('programsFilter');
    if (!container) return;

    if (programs.length === 0) {
        container.innerHTML = `
            <div class="glass-card rounded-xl p-8 text-center col-span-full">
                <i data-feather="inbox" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-300 mb-2">No Programs Found</h3>
                <p class="text-gray-400">Create programs first to manage classes</p>
            </div>
        `;
        feather.replace();
        return;
    }

    container.innerHTML = programs.map((program, index) => `
        <div class="program-filter glass-card rounded-xl p-4 ${selectedProgramId === program.id ? 'active' : ''}" 
             onclick="selectProgram('${program.id}', '${program.name.replace(/'/g, "\\'")}')"
             data-aos-delay="${index * 50}">
            <div class="flex items-start justify-between mb-3">
                <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-undefined-500/20 to-purple-500/20 flex items-center justify-center">
                    <i data-feather="archive" class="w-6 h-6 text-undefined-400"></i>
                </div>
                <span class="px-2 py-1 bg-undefined-500/20 text-undefined-300 rounded-full text-xs font-medium">
                    ${program.duration || 'N/A'} Years
                </span>
            </div>
            <h3 class="font-semibold text-white mb-1">${program.name}</h3>
            <p class="text-xs text-gray-400 line-clamp-2">${program.description || 'No description'}</p>
        </div>
    `).join('');

    feather.replace();
    AOS.init({
        duration: 600,
        easing: 'ease-out-quad',
        once: true
    });
}

// Populate program select in modal
function populateProgramSelect() {
    const select = document.getElementById('programSelect');
    if (!select) return;

    select.innerHTML = '<option value="">Choose a program...</option>' + 
        programs.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
}

// Select program
function selectProgram(programId, programName) {
    selectedProgramId = programId;
    selectedProgramName = programName || 'All Classes';
    
    document.getElementById('selectedProgramName').textContent = selectedProgramName;
    
    // Update active state
    document.querySelectorAll('.program-filter').forEach(card => {
        card.classList.remove('active');
    });
    if (programId) {
        const activeCard = document.querySelector(`[onclick="selectProgram('${programId}']`);
        if (activeCard) activeCard.classList.add('active');
    }
    
    fetchClasses();
}

// Render classes
function renderClasses(classesToRender) {
    const container = document.getElementById('classesContainer');
    if (!container) return;

    if (classesToRender.length === 0) {
        container.innerHTML = `
            <div class="glass-card rounded-2xl p-8 text-center col-span-full">
                <i data-feather="book" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-300 mb-2">No Classes Found</h3>
                <p class="text-gray-400 mb-4">Create your first class to get started</p>
                <button onclick="document.getElementById('openAddClassModal').click()" class="btn-primary">
                    <i data-feather="plus" class="w-4 h-4 mr-2"></i>
                    Create Class
                </button>
            </div>
        `;
        feather.replace();
        return;
    }

    container.innerHTML = classesToRender.map((classItem, index) => {
        const program = programs.find(p => p.id === classItem.programId);
        const enrollmentCount = Math.floor(Math.random() * (classItem.maxCapacity || 30));
        const enrollmentPercentage = classItem.maxCapacity ? (enrollmentCount / classItem.maxCapacity) * 100 : 0;

        return `
            <div class="class-card glass-card rounded-2xl overflow-hidden cursor-pointer" 
                 onclick="viewClassDetails('${classItem.id}')"
                 data-aos="fade-up" data-aos-delay="${index * 50}">
                <div class="relative h-48 overflow-hidden">
                    <img src="${classItem.imageUrl || generateRandomImageUrl()}" 
                         alt="${classItem.name}" 
                         class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent"></div>
                    
                    <div class="absolute top-4 right-4">
                        <span class="px-3 py-1 bg-undefined-500/20 backdrop-blur-sm text-undefined-300 rounded-full text-xs font-medium border border-undefined-400/30">
                            Year ${classItem.year || 'N/A'}
                        </span>
                    </div>
                </div>
                
                <div class="p-6">
                    <h3 class="text-xl font-bold text-white mb-2">${classItem.name}</h3>
                    <p class="text-sm text-gray-400 mb-4 line-clamp-2">${classItem.description || 'No description available'}</p>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Program:</span>
                            <span class="text-undefined-400 font-medium">${program?.name || 'Unknown'}</span>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Capacity:</span>
                            <span class="text-white">
                                ${enrollmentCount}/${classItem.maxCapacity || 30}
                                <span class="text-gray-400 ml-1">students</span>
                            </span>
                        </div>
                        
                        <div class="relative">
                            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-500 ${enrollmentPercentage > 80 ? 'bg-red-500' : enrollmentPercentage > 60 ? 'bg-amber-500' : 'bg-emerald-500'}" 
                                     style="width: ${enrollmentPercentage}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">${enrollmentPercentage.toFixed(0)}% enrolled</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    feather.replace();
    AOS.init({
        duration: 600,
        easing: 'ease-out-quad',
        once: true
    });
}

// Chart.js setup
function initCharts() {
    const ctxBar = document.getElementById('classesByYearChart').getContext('2d');
    classesByYearChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'],
            datasets: [{
                label: 'Classes',
                data: [0, 0, 0, 0, 0],
                backgroundColor: 'rgba(84, 119, 255, 0.6)',
                borderColor: 'rgba(84, 119, 255, 1)',
                borderWidth: 1,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    cornerRadius: 8
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#cbd5e1' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#cbd5e1', stepSize: 1 }
                }
            }
        }
    });

    const ctxDoughnut = document.getElementById('programDistributionChart').getContext('2d');
    programDistributionChart = new Chart(ctxDoughnut, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                label: 'Classes',
                data: [],
                backgroundColor: [
                    'rgba(84,119,255,0.8)',
                    'rgba(139,92,246,0.8)',
                    'rgba(59,130,246,0.8)',
                    'rgba(99,102,241,0.8)',
                    'rgba(168,85,247,0.8)',
                    'rgba(236,72,153,0.8)',
                    'rgba(14,165,233,0.8)',
                    'rgba(34,197,94,0.8)'
                ],
                borderColor: 'rgba(15, 23, 42, 0.6)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#cbd5e1',
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}

function updateCharts() {
    // Bar: Classes by Year
    const byYear = [0,0,0,0,0];
    classes.forEach(c => {
        const y = parseInt(c.year, 10);
        if (y >=1 && y <=5) byYear[y-1]++;
    });

    if (classesByYearChart) {
        classesByYearChart.data.datasets[0].data = byYear;
        classesByYearChart.update('none');
    }

    const hasData = byYear.some(v => v > 0);
    document.getElementById('classesByYearEmpty').classList.toggle('hidden', hasData);

    // Doughnut: Program distribution
    const programLabels = programs.map(p => p.name);
    const programData = programs.map(p => classes.filter(c => c.programId === p.id).length);

    if (programDistributionChart) {
        programDistributionChart.data.labels = programLabels;
        programDistributionChart.data.datasets[0].data = programData;
        programDistributionChart.update('none');
    }

    const hasProgramData = programData.some(v => v > 0);
    document.getElementById('programDistributionEmpty').classList.toggle('hidden', hasProgramData);
}

// Modal functions
function openAddClassModal() {
    const modal = document.getElementById('addClassModal');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    modal.querySelector('.transform').classList.remove('scale-95');
    document.body.style.overflow = 'hidden';
    
    // Pre-select if a program is selected
    if (selectedProgramId) {
        document.getElementById('programSelect').value = selectedProgramId;
    }
}

function closeAddClassModal() {
    const modal = document.getElementById('addClassModal');
    modal.classList.add('opacity-0', 'pointer-events-none');
    modal.querySelector('.transform').classList.add('scale-95');
    document.body.style.overflow = '';
    
    // Reset form
    document.getElementById('createClassForm').reset();
    clearImage();
}

// Image handling
function generateRandomImage() {
    currentImageUrl = generateRandomImageUrl();
    const preview = document.getElementById('imagePreview');
    const img = preview.querySelector('img');
    img.src = currentImageUrl;
    preview.classList.remove('hidden');
    document.getElementById('imageUploadArea').classList.add('has-image');
}

function clearImage() {
    currentImageUrl = '';
    document.getElementById('imagePreview').classList.add('hidden');
    document.getElementById('imageUploadArea').classList.remove('has-image');
    document.getElementById('imageInput').value = '';
}

// Generate random image URL
function generateRandomImageUrl() {
    const categories = ['education', 'technology', 'science', 'workspace'];
    const category = categories[Math.floor(Math.random() * categories.length)];
    const seed = Math.floor(Math.random() * 1000);
    return `https://picsum.photos/seed/${encodeURIComponent(category + '-' + seed)}/640/360`;
}

// Create class
async function createClass(e) {
    e.preventDefault();
    
    const formData = {
        programId: document.getElementById('programSelect').value,
        name: document.getElementById('classNameInput').value.trim(),
        year: document.getElementById('yearSelect').value,
        maxCapacity: parseInt(document.getElementById('capacityInput').value),
        description: document.getElementById('classDescription').value.trim(),
        imageUrl: currentImageUrl || generateRandomImageUrl(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const deptId = localStorage.getItem('currentDeptId');
    if (!deptId) {
        alert('Department not found. Please login again.');
        return;
    }

    try {
        await db.collection('departments').doc(deptId).collection('classes').add(formData);
        
        closeAddClassModal();
        showSuccessToast();
        fetchClasses();
    } catch (error) {
        console.error('Error creating class:', error);
        alert('Failed to create class: ' + error.message);
    }
}

// View class details
function viewClassDetails(classId) {
    console.log('Viewing class:', classId);
}

// Show success toast
function showSuccessToast() {
    const toast = document.getElementById('successToast');
    toast.classList.remove('translate-x-full');
    
    setTimeout(() => {
        toast.classList.add('translate-x-full');
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    // Initialize particles
    createParticles();

    // Initialize charts
    initCharts();
    
    // Check authentication
    auth.onAuthStateChanged((user) => {
        if (!user) {
            window.location.href = '/index.html';
            return;
        }
        
        // Fetch data
        fetchPrograms();
        fetchClasses();
    });

    // Modal open button
    document.getElementById('openAddClassModal').addEventListener('click', openAddClassModal);

    // Image upload
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('imageInput');
    
    imageUploadArea.addEventListener('click', () => imageInput.click());
    
    imageUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadArea.classList.add('bg-undefined-500/10');
    });
    
    imageUploadArea.addEventListener('dragleave', () => {
        imageUploadArea.classList.remove('bg-undefined-500/10');
    });
    
    imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.classList.remove('bg-undefined-500/10');
        
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageUrl = e.target.result;
                const preview = document.getElementById('imagePreview');
                const img = preview.querySelector('img');
                img.src = currentImageUrl;
                preview.classList.remove('hidden');
                imageUploadArea.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
    });
    
    imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageUrl = e.target.result;
                const preview = document.getElementById('imagePreview');
                const img = preview.querySelector('img');
                img.src = currentImageUrl;
                preview.classList.remove('hidden');
                imageUploadArea.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
    });

    // Form submission
    document.getElementById('createClassForm').addEventListener('submit', createClass);

    // Search and filter
    document.getElementById('classSearch').addEventListener('input', fetchClasses);
    document.getElementById('yearFilter').addEventListener('change', fetchClasses);

    // Initialize Feather icons
    feather.replace();
});

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = document.getElementById('addClassModal');
        if (!modal.classList.contains('pointer-events-none')) {
            closeAddClassModal();
        }
    }
});
    </script>
    <script>feather.replace();</script>
<script src="https://huggingface.co/deepsite/deepsite-badge.js"></script>
</body>
</html>