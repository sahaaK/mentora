<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale.0"/>
    <title>Class Students</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='50' x='8' font-size='48'%3EðŸŽ“%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                500: '#6366f1' // indigo-500
              },
              secondary: {
                500: '#06b6d4' // cyan-500
              }
            },
            boxShadow: {
              glass: '0 10px 40px rgba(0,0,0,0.35)',
              ring: '0 0 0 1px rgba(255,255,255,0.06) inset, 0 1px 0 rgba(255,255,255,0.08)'
            },
            keyframes: {
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-8px)' } },
              tilt: {
                '0%': { transform: 'rotateX(0) rotateY(0)' },
                '100%': { transform: 'rotateX(0) rotateY(0)' }
              },
              sweep: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(100%)' }
              }
            },
            animation: {
              float: 'float 8s ease-in-out infinite',
              tilt: 'tilt 12s ease-in-out infinite',
              sweep: 'sweep 2.2s linear infinite'
            },
            backdropBlur: {
              xs: '2px'
            }
          }
        },
        darkMode: 'class'
      }
    </script>
    <link href="https://unpkg.com/feather-icons@4.29.2/dist/feather.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/depy/components/sidebar.css"/>

    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }

      /* Glass panel styles */
      .glass-card {
        background: rgba(15, 23, 42, 0.5);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.4s ease;
        border-radius: 16px;
      }

      .glass-card:hover {
        background: rgba(15, 23, 42, 0.8);
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
      }

      /* Animated gradient border */
      .gradient-border {
        position: relative;
        z-index: 1;
      }

      .gradient-border::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #6366f1, #8b5cf6, #ec4899);
        z-index: -1;
        border-radius: 18px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .glass-card:hover .gradient-border::before {
        opacity: 1;
      }

      /* Bubble animation container */
      .bubble-container {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: -1;
        overflow: hidden;
      }

      .bubble {
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.1), rgba(147, 51, 234, 0.05));
        backdrop-filter: blur(1px);
        animation: float 20s infinite ease-in-out;
      }

      @keyframes float {
        0%, 100% {
          transform: translateY(0) translateX(0) scale(1);
        }
        33% {
          transform: translateY(-100px) translateX(50px) scale(1.1);
        }
        66% {
          transform: translateY(50px) translateX(-50px) scale(0.9);
        }
      }

      /* Selection highlight for cards in modal */
      .student-card.selected {
        outline: 2px solid #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
      }

      /* Scrollbar for modal grid */
      #studentsGrid::-webkit-scrollbar {
        width: 8px;
      }
      #studentsGrid::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
      }
      #studentsGrid::-webkit-scrollbar-track {
        background: transparent;
      }
    </style>
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 antialiased selection:bg-primary-500/30 selection:text-white relative">

    <!-- Bubble background -->
    <div class="bubble-container"></div>
     <div id="sidebar-root"></div>
    <script src="/depy/classes/classes-sidebar.js"></script>

    <!-- Header -->
    <header class="sticky top-0 z-20 border-b border-white/5 bg-slate-950/40 backdrop-blur-md">
        <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-white/10 grid place-items-center ring-1 ring-white/10 shadow-glass">
                    <i data-feather="users"></i>
                </div>
                <div>
                    <h1 class="text-lg font-semibold tracking-tight">Class Students</h1>
                    <p class="text-xs text-slate-400">Manage and add students to this class</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="addStudentBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-xl flex items-center gap-2 transition-all shadow-lg shadow-primary-500/30">
                    <i data-feather="user-plus" class="w-4 h-4"></i>
                    <span>Add Student</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-6 py-8">
        <!-- Class Students Grid -->
        <section id="classStudents" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"></section>

        <!-- Empty State -->
        <div id="emptyState" class="hidden glass-card p-10 text-center mt-8">
            <i data-feather="user-x" class="w-12 h-12 text-slate-500 mx-auto mb-4"></i>
            <h3 class="text-xl font-semibold text-slate-300 mb-2">No students in this class yet</h3>
            <p class="text-slate-400 mb-6">Click "Add Student" to select and assign students from your records.</p>
            <button id="addStudentBtnEmpty" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-xl flex items-center gap-2 transition-all shadow-lg shadow-primary-500/30 mx-auto">
                <i data-feather="user-plus" class="w-4 h-4"></i>
                <span>Add Student</span>
            </button>
        </div>
    </main>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-7xl max-h-[90vh] bg-slate-950/80 backdrop-blur-xl border border-white/10 rounded-2xl shadow-glass overflow-hidden">
            <div class="flex items-center justify-between border-b border-white/10 px-6 py-4">
                <div>
                    <h2 class="text-lg font-semibold">Select Students</h2>
                    <p class="text-xs text-slate-400">Choose students to add to this class</p>
                </div>
                <button id="closeAddStudentModal" class="p-2 rounded-lg hover:bg-white/10 transition-all">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Search + Filter -->
            <div class="px-6 py-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="relative flex-1">
                        <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input id="studentSearch" type="text" placeholder="Search by name, phone, department..." class="w-full pl-10 pr-3 py-2 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/50 text-sm">
                    </div>
                    <button id="selectAllBtn" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm">Select All</button>
                    <button id="clearAllBtn" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm">Clear</button>
                </div>
            </div>

            <!-- Students Grid -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                <div id="studentsGrid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
            </div>

            <!-- Footer -->
            <div class="flex items-center justify-between border-t border-white/10 px-6 py-4">
                <div class="text-sm text-slate-300">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="flex items-center gap-3">
                    <button id="cancelAddBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition-all">Cancel</button>
                    <button id="confirmAddBtn" disabled class="px-4 py-2 rounded-xl bg-primary-500 hover:bg-primary-600 text-white transition-all shadow-lg shadow-primary-500/30 disabled:opacity-50 disabled:cursor-not-allowed">Add Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-[60] opacity-0 pointer-events-none transition-all">
        <div id="toastText" class="px-4 py-3 rounded-xl bg-slate-900/90 border border-white/10 text-sm shadow-glass"></div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script>
      // Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCPV_mXojZBR-Dew8RuZSi9jv9X6rc_D90",
    authDomain: "mentora-71f5c.firebaseapp.com",
    projectId: "mentora-71f5c",
    storageBucket: "mentora-71f5c.appspot.com",
    messagingSenderId: "16685388211",
    appId: "1:16685388211:web:7eed812660439dec7b3bc6",
    measurementId: "G-BL98PXGK2G"
};

// Initialize Firebase + Firestore
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// State
let CLASS_ID = '';
let ALL_STUDENTS = [];
let CLASS_STUDENTS_SET = new Set();
let SELECTED_STUDENTS = new Set();

// UI refs
const addStudentBtn = document.getElementById('addStudentBtn');
const addStudentBtnEmpty = document.getElementById('addStudentBtnEmpty');
const addStudentModal = document.getElementById('addStudentModal');
const closeAddStudentModal = document.getElementById('closeAddStudentModal');
const cancelAddBtn = document.getElementById('cancelAddBtn');
const confirmAddBtn = document.getElementById('confirmAddBtn');
const studentsGrid = document.getElementById('studentsGrid');
const selectedCountEl = document.getElementById('selectedCount');
const studentSearch = document.getElementById('studentSearch');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const classStudentsGrid = document.getElementById('classStudents');
const emptyState = document.getElementById('emptyState');

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const text = document.getElementById('toastText');
    text.textContent = message;
    toast.classList.remove('opacity-0', 'pointer-events-none');
    toast.classList.add('opacity-100', 'pointer-events-auto');

    // Color based on type
    const bg = type === 'error' ? 'bg-rose-600' : (type === 'warning' ? 'bg-amber-500' : 'bg-slate-900');
    text.className = `px-4 py-3 rounded-xl border border-white/10 text-sm shadow-glass ${bg} text-white`;

    setTimeout(() => {
        toast.classList.remove('opacity-100', 'pointer-events-auto');
        toast.classList.add('opacity-0', 'pointer-events-none');
    }, 2400);
}

function openModal() {
    addStudentModal.classList.remove('opacity-0', 'pointer-events-none');
    document.body.style.overflow = 'hidden';
}
function closeModal() {
    addStudentModal.classList.add('opacity-0', 'pointer-events-none');
    document.body.style.overflow = '';
}

function getClassId() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromUrl = urlParams.get('classId');
    if (fromUrl) {
        localStorage.setItem('currentClassId', fromUrl);
        return fromUrl;
    }
    const fromStorage = localStorage.getItem('currentClassId');
    return fromStorage || '';
}

function initials(name = '') {
    return String(name)
        .split(' ')
        .filter(Boolean)
        .slice(0, 2)
        .map(s => s[0].toUpperCase())
        .join('');
}

function gradeToProgress(grade = '') {
    const map = { 'A+': 98, 'A': 94, 'A-': 90, 'B+': 85, 'B': 78, 'B-': 72, 'C+': 66, 'C': 60, 'C-': 54, 'D': 45, 'F': 25 };
    return map[grade.toUpperCase()] ?? 62;
}

function maskPhone(phone = '') {
    const digits = phone.replace(/[^+\d]/g, '');
    return digits.replace(/(\+\d{1,3})\s?(\d{3})\d{3}(\d{4})/, '$1 $2-***-$4');
}

function sparklineData(seed, len = 24) {
    const base = seed * 7 + 13;
    let arr = [];
    let v = 50 + (base % 40);
    for (let i = 0; i < len; i++) {
        v += (Math.sin((i + base) / 3) * 8) + (Math.random() * 6 - 3);
        v = Math.max(10, Math.min(100, v));
        arr.push(v.toFixed(1));
    }
    return arr;
}

function sparklineSVG(values, colorA = 'rgb(99,102,241)', colorB = 'rgb(168,85,247)') {
    const w = 280, h = 70, pad = 6;
    const min = Math.min(...values), max = Math.max(...values);
    const scaleX = (i) => pad + (i * (w - 2*pad) / (values.length - 1));
    const scaleY = (val) => {
        const t = (val - min) / (max - min || 1);
        return h - pad - t * (h - 2*pad);
    };
    const points = values.map((v, i) => `${scaleX(i)},${scaleY(v)}`).join(' ');
    const area = [
        `${scaleX(0)},${h-pad}`,
        ...values.map((v, i) => `${scaleX(i)},${scaleY(v)}`),
        `${scaleX(values.length-1)},${h-pad}`
    ].join(' ');

    return `
      <svg viewBox="0 0 ${w} ${h}" class="w-full h-16">
        <defs>
          <linearGradient id="gradModal" x1="0" x2="1" y1="0" y2="0">
            <stop offset="0%" stop-color="${colorA}"/>
            <stop offset="100%" stop-color="${colorB}"/>
          </linearGradient>
          <linearGradient id="gradModalArea" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="${colorA.replace('1)', '.35)')}"/>
            <stop offset="100%" stop-color="${colorB.replace('1)', '.05)')}"/>
          </linearGradient>
        </defs>
        <polyline fill="none" stroke="url(#gradModal)" stroke-width="2" points="${points}" />
        <polygon fill="url(#gradModalArea)" points="${area}" />
      </svg>
    `;
}

// Build Nebula card variant for the modal selection grid
function buildStudentCard(student, isSelected = false) {
    const prog = gradeToProgress(student.grade);
    const avaUrl = student.profileImageData || student.profileImageUrl || '';

    return `
      <article class="student-card relative group overflow-hidden rounded-2xl bg-white/5 shadow-glass ring-1 ring-white/10 backdrop-blur-md preserve-3d animate-tilt ring-gradient sweep noise ${isSelected ? 'selected' : ''}"
               data-id="${student.id}">
        <div class="absolute inset-x-0 bottom-0 h-1 bg-gradient-to-r from-purple-200/60 to-emerald-200/30"></div>

        <div class="p-5">
          <div class="flex items-center gap-4">
            <div class="relative">
              <div class="absolute inset-0 bg-emerald-500 opacity-25 blur-md rounded-full"></div>
              ${avaUrl ? `
                <img alt="${student.fullName} avatar" src="${avaUrl}" class="relative h-20 w-20 rounded-2xl object-cover ring-2 ring-white/20 shadow-lg" />
              ` : `
                <div class="relative h-20 w-20 rounded-2xl bg-emerald-500 grid place-items-center ring-2 ring-white/20 shadow-lg">
                  <span class="text-xl font-extrabold text-white">${initials(student.fullName)}</span>
                </div>
              `}
            </div>
            <div class="min-w-0">
              <h3 class="truncate text-lg font-bold">${student.fullName}</h3>
              <p class="truncate text-sm text-slate-300">${student.department || 'â€”'} â€¢ ${student.faculty || 'â€”'}</p>
              <div class="mt-1 flex items-center gap-2">
                <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-2 py-0.5 text-xs font-medium text-slate-200 ring-1 ring-white/10"><i data-feather="award"></i> ${student.grade || 'â€”'}</span>
                <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-2 py-0.5 text-xs font-medium text-slate-200 ring-1 ring-white/10"><i data-feather="calendar"></i> ${student.age || 'â€”'}</span>
              </div>
            </div>
            <div class="ml-auto">
              <input type="checkbox" class="h-5 w-5 rounded border-white/20 bg-white/10 text-primary-500 focus:ring-primary-500/50 student-select" ${isSelected ? 'checked' : ''} />
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 gap-4">
            <div>
              <div class="mb-2 flex items-center justify-between text-xs text-slate-300">
                <span class="inline-flex items-center gap-1"><i data-feather="cpu"></i> Performance Spark</span>
                <span class="font-semibold text-white">${prog}%</span>
              </div>
              <div class="rounded-xl bg-white/10 p-3 ring-1 ring-white/10">
                ${sparklineSVG(sparklineData(prog + (student.age || 20), 24), 'rgb(34,197,94)', 'rgba(250,204,21,0.45)')}
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-xl bg-white/10 p-3 text-sm ring-1 ring-white/10">
                <div class="text-slate-300">Guardian</div>
                <div class="font-semibold">${student.guardianName || 'â€”'}</div>
              </div>
              <div class="rounded-xl bg-white/10 p-3 text-sm ring-1 ring-white/10">
                <div class="text-slate-300">City</div>
                <div class="font-semibold">${student.city || 'â€”'}</div>
              </div>
            </div>

            <div class="flex flex-wrap gap-2">
              <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-2.5 py-1 text-xs font-medium text-slate-200 ring-1 ring-white/10"><i data-feather="home"></i> ${student.graduatedFrom || 'â€”'}</span>
              <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-2.5 py-1 text-xs font-medium text-slate-200 ring-1 ring-white/10"><i data-feather="droplet"></i> ${student.bloodType || 'â€”'}</span>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between gap-3 border-t border-white/10 bg-white/[0.02] px-5 py-3">
          <div class="flex items-center gap-2 text-slate-300"><i data-feather="phone"></i><a href="tel:${(student.phone || '').replace(/[^+\d]/g,'')}" class="hover:text-white transition">${maskPhone(student.phone || '')}</a></div>
          <div class="flex items-center gap-2 text-slate-300"><i data-feather="shield"></i><span class="text-xs">${student.guardianName || 'â€”'}</span></div>
        </div>

        <div class="pointer-events-none absolute right-3 top-3 text-[10px] uppercase tracking-widest text-white/60">Nebula â€¢ Select</div>
      </article>
    `;
}

function buildClassStudentCard(student) {
    const prog = gradeToProgress(student.grade);
    const avaUrl = student.profileImageData || student.profileImageUrl || '';
    return `
      <article class="glass-card p-5 group animate-slide-up">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-16 h-16 rounded-xl overflow-hidden ring-1 ring-white/10">
            ${avaUrl ? `
              <img src="${avaUrl}" alt="${student.fullName}" class="w-full h-full object-cover">
            ` : `
              <div class="w-full h-full bg-white/10 grid place-items-center text-white font-bold text-xl">${initials(student.fullName)}</div>
            `}
          </div>
          <div class="min-w-0">
            <h3 class="font-bold truncate">${student.fullName}</h3>
            <p class="text-sm text-slate-300 truncate">${student.department || 'â€”'} â€¢ ${student.faculty || 'â€”'}</p>
            <div class="mt-1 flex items-center gap-2">
              <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-2 py-0.5 text-xs font-medium text-slate-200 ring-1 ring-white/10"><i data-feather="award"></i> ${student.grade || 'â€”'}</span>
              <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-2 py-0.5 text-xs font-medium text-slate-200 ring-1 ring-white/10"><i data-feather="calendar"></i> ${student.age || 'â€”'}</span>
            </div>
          </div>
        </div>

        <div class="space-y-2 mb-4 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">Phone:</span>
            <span>${maskPhone(student.phone || '')}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Guardian:</span>
            <span class="truncate max-w-[55%]">${student.guardianName || 'â€”'}</span>
          </div>
          <div class="mt-2">
            <div class="flex justify-between text-xs text-slate-400 mb-1">
              <span>Performance</span>
              <span>${prog}%</span>
            </div>
            <div class="h-2 w-full rounded-full bg-white/10 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-amber-200/60 to-emerald-200/30" style="width:${prog}%"></div>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white/5 rounded-lg hover:bg-white/10 transition-all" title="Details">
            <i data-feather="eye"></i> View
          </button>
          <button class="px-3 py-2 bg-rose-500/10 hover:bg-rose-500/20 text-rose-300 rounded-lg transition-all remove-student-btn" data-id="${student.id}" title="Remove">
            <i data-feather="trash-2"></i>
          </button>
        </div>
      </article>
    `;
}

function renderClassStudents() {
    if (!CLASS_STUDENTS_SET.size) {
        classStudentsGrid.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }
    emptyState.classList.add('hidden');

    const cards = [];
    CLASS_STUDENTS_SET.forEach(id => {
        const s = ALL_STUDENTS.find(x => x.id === id);
        if (s) cards.push(buildClassStudentCard(s));
    });

    classStudentsGrid.innerHTML = cards.join('');
    feather.replace();

    // Bind remove buttons
    document.querySelectorAll('.remove-student-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const sid = e.currentTarget.dataset.id;
            await removeStudentFromClass(sid);
        });
    });
}

function renderModalStudents(filter = '') {
    const q = filter.trim().toLowerCase();
    const filtered = ALL_STUDENTS.filter(s => {
        if (!q) return true;
        const hay = [
            s.fullName, s.phone, s.department, s.faculty,
            s.graduatedFrom, s.city, s.education, s.guardianName
        ].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
    });

    studentsGrid.innerHTML = filtered.map(s => buildStudentCard(s, SELECTED_STUDENTS.has(s.id))).join('');
    feather.replace();

    // Bind checkboxes and click selection
    document.querySelectorAll('.student-select').forEach(chk => {
        chk.addEventListener('change', (e) => {
            const card = e.target.closest('.student-card');
            const id = card.dataset.id;
            if (e.target.checked) {
                SELECTED_STUDENTS.add(id);
                card.classList.add('selected');
            } else {
                SELECTED_STUDENTS.delete(id);
                card.classList.remove('selected');
            }
            updateSelectedCount();
        });
    });

    document.querySelectorAll('.student-card').forEach(card => {
        card.addEventListener('click', (e) => {
            // Ignore clicks on links/buttons
            if (e.target.closest('a,button,input')) return;
            const id = card.dataset.id;
            const input = card.querySelector('.student-select');
            input.checked = !input.checked;
            input.dispatchEvent(new Event('change', { bubbles: true }));
        });
    });

    updateSelectedCount();
}

function updateSelectedCount() {
    const count = SELECTED_STUDENTS.size;
    selectedCountEl.textContent = count;
    confirmAddBtn.disabled = count === 0;
}

async function fetchAllStudents() {
    const snap = await db.collection('students').orderBy('createdAt', 'desc').get();
    ALL_STUDENTS = [];
    snap.forEach(doc => ALL_STUDENTS.push({ id: doc.id, ...doc.data() }));
}

async function fetchClassStudents() {
    const snap = await db.collection('classes').doc(CLASS_ID).collection('students').get();
    CLASS_STUDENTS_SET = new Set();
    snap.forEach(doc => CLASS_STUDENTS_SET.add(doc.id));
}

async function addSelectedStudents() {
    const toAdd = Array.from(SELECTED_STUDENTS);
    if (!toAdd.length) return;

    confirmAddBtn.disabled = true;
    confirmAddBtn.innerHTML = `<span class="flex items-center gap-2"><span>Adding...</span><div class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full animate-spin"></div></span>`;

    try {
        const batch = db.batch();
        const classRef = db.collection('classes').doc(CLASS_ID);
        toAdd.forEach(id => {
            const ref = classRef.collection('students').doc(id);
            // setIfMissing semantics with batch: we can check existence, but Firestore doesn't support in-batch exists check.
            // We'll set unconditionally; if exists, it will be a no-op.
            batch.set(ref, { addedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        });
        await batch.commit();

        showToast(`Added ${toAdd.length} student(s) to the class.`, 'success');
        await fetchClassStudents();
        renderClassStudents();
        closeModal();
        SELECTED_STUDENTS.clear();
        studentsGrid.innerHTML = '';
    } catch (err) {
        console.error(err);
        showToast('Failed to add students. Please try again.', 'error');
    } finally {
        confirmAddBtn.disabled = false;
        confirmAddBtn.innerHTML = 'Add Selected';
    }
}

async function removeStudentFromClass(studentId) {
    try {
        await db.collection('classes').doc(CLASS_ID).collection('students').doc(studentId).delete();
        CLASS_STUDENTS_SET.delete(studentId);
        renderClassStudents();
        showToast('Student removed from class.', 'success');
    } catch (err) {
        console.error(err);
        showToast('Failed to remove student.', 'error');
    }
}

// Bubble animation from final.html
function createBubbles() {
  const container = document.querySelector('.bubble-container');
  const bubbleCount = 15;
  for (let i = 0; i < bubbleCount; i++) {
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    const size = Math.random() * 100 + 50;
    const left = Math.random() * 100;
    const top = Math.random() * 100;
    const delay = Math.random() * 10;
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.left = `${left}%`;
    bubble.style.top = `${top}%`;
    bubble.style.animationDelay = `${delay}s`;
    container.appendChild(bubble);
  }
}

// Event bindings
addStudentBtn.addEventListener('click', async () => {
    await fetchAllStudents();
    // Pre-select none; show all
    SELECTED_STUDENTS.clear();
    renderModalStudents();
    openModal();
});
addStudentBtnEmpty.addEventListener('click', async () => {
    await fetchAllStudents();
    SELECTED_STUDENTS.clear();
    renderModalStudents();
    openModal();
});

closeAddStudentModal.addEventListener('click', closeModal);
cancelAddBtn.addEventListener('click', closeModal);
document.querySelector('#addStudentModal .absolute.inset-0.bg-black\\/70').addEventListener('click', closeModal);

confirmAddBtn.addEventListener('click', addSelectedStudents);

studentSearch.addEventListener('input', (e) => {
    renderModalStudents(e.target.value || '');
});

selectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('.student-card').forEach(card => {
        const id = card.dataset.id;
        SELECTED_STUDENTS.add(id);
        const input = card.querySelector('.student-select');
        if (input) input.checked = true;
        card.classList.add('selected');
    });
    updateSelectedCount();
});

clearAllBtn.addEventListener('click', () => {
    SELECTED_STUDENTS.clear();
    document.querySelectorAll('.student-card').forEach(card => {
        const input = card.querySelector('.student-select');
        if (input) input.checked = false;
        card.classList.remove('selected');
    });
    updateSelectedCount();
});

// Escape to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !addStudentModal.classList.contains('opacity-0')) {
        closeModal();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    feather.replace();
    createBubbles();

    CLASS_ID = getClassId();
    if (!CLASS_ID) {
        showToast('No class selected. Provide classId in URL or set it in localStorage.', 'error');
        return;
    }

    await fetchAllStudents();
    await fetchClassStudents();
    renderClassStudents();
});
    </script>
</body>
</html>