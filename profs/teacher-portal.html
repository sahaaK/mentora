<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Portal</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>
  <!-- Tailwind + Icons + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            primary: {
              50:  '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#c4b5fd',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#5b21b6',
              900: '#4c1d95',
              950: '#2e1065'
            },
            secondary: {
              50:  '#fdf4ff',
              100: '#fae8ff',
              200: '#f5d0fe',
              300: '#f0abfc',
              400: '#e879f9',
              500: '#d946ef',
              600: '#c026d3',
              700: '#a21caf',
              800: '#86198f',
              900: '#701a75',
              950: '#4a044e'
            },
            surface: {
              50:  '#0b1020',
              100: '#0f172a',
              200: '#111827',
              300: '#1f2937',
              400: '#374151'
            }
          },
          boxShadow: {
            glass: '0 10px 40px rgba(0,0,0,0.35)'
          },
          keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            pulseGlow: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(139,92,246,.5)' }, '50%': { boxShadow: '0 0 0 10px rgba(139,92,246,0)' } },
            modalIn: { '0%': { opacity: 0, transform: 'translateY(12px) scale(.98)' }, '100%': { opacity: 1, transform: 'translateY(0) scale(1)' } },
            slideUp: { '0%': { opacity: 0, transform: 'translateY(12px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
            shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
          },
          animation: {
            float: 'float 8s ease-in-out infinite',
            pulseGlow: 'pulseGlow 2.5s ease-in-out infinite',
            modalIn: 'modalIn .25s ease-out',
            slideUp: 'slideUp .35s ease-out',
            shimmer: 'shimmer 2.2s linear infinite'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="style.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* Global base */
* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  background: #0b1020;
  color: #e2e8f0;
}

/* Glass components */
.glass-card {
  background: rgba(17, 24, 39, 0.6);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 40px rgba(0,0,0,0.35);
  transition: all .35s cubic-bezier(.2,.9,.3,1);
  border-radius: 18px;
}
.glass-card:hover {
  background: rgba(17, 24, 39, 0.75);
  transform: translateY(-3px);
  box-shadow: 0 14px 50px rgba(0,0,0,0.45);
}

/* Gradient border effect (purple theme) */
.gradient-border {
  position: relative;
  z-index: 1;
}
.gradient-border::before {
  content: '';
  position: absolute;
  inset: -1px;
  border-radius: calc(18px + 2px);
  background: linear-gradient(135deg, rgba(139,92,246,.55), rgba(217,70,239,.45), rgba(99,102,241,.4));
  filter: blur(8px);
  opacity: .6;
  transition: opacity .35s ease;
  z-index: -1;
}
.glass-card:hover .gradient-border::before {
  opacity: .95;
}

/* Faculty/department image styling */
.faculty-img, .department-img {
  position: relative;
  overflow: hidden;
}
.faculty-img::after, .department-img::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(120% 120% at 20% 0%, rgba(139,92,246,0.2), rgba(217,70,239,0.12) 40%, transparent 70%);
  pointer-events: none;
}
.faculty-img img, .department-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform .4s ease;
}
.glass-card:hover .faculty-img img,
.glass-card:hover .department-img img {
  transform: scale(1.05);
}

/* Stats */
.stat-item {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 12px;
  transition: all .3s ease;
}
.stat-item:hover {
  background: rgba(255,255,255,0.08);
  transform: translateY(-2px);
}

/* Bubble background generator */
#bubbles {
  position: fixed;
  inset: 0;
  overflow: hidden;
  pointer-events: none;
  z-index: -1;
}
.bubble {
  position: absolute;
  bottom: -10vh;
  background: radial-gradient(circle at 30% 30%, rgba(139,92,246,.18), rgba(217,70,239,.10));
  backdrop-filter: blur(1px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 50%;
  animation: floatUp var(--t, 22s) linear infinite;
  opacity: .5;
  filter: blur(0.2px);
}
@keyframes floatUp {
  from { transform: translateY(0) translateX(0) scale(1); opacity: .5; }
  to   { transform: translateY(-120vh) translateX(var(--dx, 40px)) scale(1.05); opacity: 0; }
}

/* Form inputs */
.form-input, .form-select {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  padding: 0.85rem 1rem;
  width: 100%;
  color: white;
  transition: all .25s ease;
}
.form-input::placeholder, .form-select:invalid {
  color: rgba(255,255,255,0.55);
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: rgba(139,92,246,.55);
  box-shadow: 0 0 0 3px rgba(139,92,246,.18);
}
.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-opacity='.6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 0.8rem center;
  background-size: 1em;
}

/* Shimmer for buttons */
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
.animate-shimmer {
  background: linear-gradient(110deg, transparent 0%, rgba(255,255,255,0.22) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: shimmer 2s linear infinite;
}

/* Toast */
#toast.glass-card {
  animation: slideInRight .35s ease-out, fadeOut .35s ease-out 2.6s forwards;
}
@keyframes slideInRight {
  from { transform: translateX(12px); opacity: 0; }
  to   { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOut {
  to { transform: translateX(12px); opacity: 0; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
::-webkit-scrollbar-thumb {
  background: rgba(139,92,246,0.35);
  border-radius: 8px;
}
::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.55); }

/* Utility */
.hidden { display: none !important; }

/* Responsive tweaks */
@media (max-width: 768px) {
  .glass-card { margin: 0 6px; }
}
  </style>
</head>
<body class="bg-surface-50 text-white min-h-screen antialiased relative overflow-x-hidden">
  <!-- Ambient animated blobs -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-24 -left-24 w-[36rem] h-[36rem] bg-primary-600/20 rounded-full blur-3xl animate-float"></div>
    <div class="absolute top-1/2 -right-24 w-[32rem] h-[32rem] bg-secondary-600/20 rounded-full blur-3xl animate-float" style="animation-delay: -2.5s"></div>
    <div class="absolute -bottom-24 left-1/3 w-[30rem] h-[30rem] bg-primary-400/10 rounded-full blur-3xl animate-float" style="animation-delay: -5s"></div>
  </div>

  <!-- Bubble backdrop -->
  <div id="bubbles" class="pointer-events-none fixed inset-0 -z-10 overflow-hidden"></div>

  <!-- Auth (Login) View -->
  <section id="authView" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
      <!-- Left branding -->
      <div class="space-y-6 animate-slideUp">
        <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5 border border-white/10 backdrop-blur-md">
          <div class="w-2 h-2 rounded-full bg-primary-500 animate-pulseGlow"></div>
          <span class="text-sm text-white/80">Welcome to the Teacher Portal</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">
          <span class="bg-gradient-to-r from-primary-400 via-primary-500 to-secondary-500 bg-clip-text text-transparent">
            Glowy Purple.
          </span>
          <br/>
          <span class="text-white/90">Modern. Glassy. Animated.</span>
        </h1>
        <p class="text-white/60 max-w-prose">
          Sign in with your credentials to manage your profile, update your details, and get a slick dashboard experience.
        </p>
      </div>

      <!-- Login Card -->
      <div class="relative">
        <div class="glass-card p-8 rounded-3xl animate-slideUp border border-white/10 shadow-glass">
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 rounded-xl bg-primary-500/20 text-primary-300">
              <i data-feather="user-check"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold">Teacher Login</h2>
              <p class="text-sm text-white/60">Access your dashboard</p>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm text-white/70 mb-2">Email or Username</label>
              <div class="relative">
                <i data-feather="mail" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50"></i>
                <input id="loginIdentifier" type="text" placeholder="you@example.com or username"
                       class="form-input pl-10" />
              </div>
            </div>

            <div>
              <label class="block text-sm text-white/70 mb-2">Password</label>
              <div class="relative">
                <i data-feather="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50"></i>
                <input id="loginPassword" type="password" placeholder="••••••••"
                       class="form-input pl-10 pr-10" />
                <button id="togglePassword" type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/50 hover:text-white/80">
                  <i data-feather="eye"></i>
                </button>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <label class="inline-flex items-center gap-2 text-white/70">
                <input id="rememberMe" type="checkbox" class="rounded border-white/20 bg-white/5 text-primary-500 focus:ring-primary-500/40 focus:ring-offset-0">
                Remember me
              </label>
              <button class="text-primary-400 hover:text-primary-300 transition">Forgot password?</button>
            </div>

            <button id="loginBtn" class="w-full relative overflow-hidden group mt-2">
              <span class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-[length:200%_100%] bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></span>
              <span class="relative flex items-center justify-center gap-2 bg-gradient-to-r from-primary-500 to-secondary-500 hover:from-primary-600 hover:to-secondary-600 transition-all text-white font-semibold py-3 rounded-xl">
                <i data-feather="log-in"></i> Sign In
              </span>
            </button>

            <p class="text-center text-sm text-white/50 mt-4">
              Demo hint: Use the teacher credentials you created in the admin dashboard.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard View -->
  <section id="dashboardView" class="hidden min-h-screen">
    <!-- Top bar -->
    <header class="px-6 pt-6">
      <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">
            <span class="bg-gradient-to-r from-primary-400 to-secondary-400 bg-clip-text text-transparent">Welcome back,</span>
            <span id="welcomeName" class="text-white">Teacher</span>
          </h1>
          <p id="welcomeMeta" class="text-white/60 text-sm">—</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="logoutBtn" class="glass px-3 py-2 rounded-lg hover:bg-white/10 transition-all flex items-center gap-2">
            <i data-feather="log-out"></i>
            <span class="hidden sm:inline">Logout</span>
          </button>
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-400 to-secondary-400 flex items-center justify-center text-white font-bold shadow-lg">
            <span id="avatarInitial">T</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto px-6 pb-16">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <!-- Profile card -->
        <div class="glass-card p-6 rounded-3xl border border-white/10 shadow-glass animate-slideUp">
          <div class="flex items-start gap-4">
            <div class="faculty-img w-24 h-24 rounded-2xl overflow-hidden border border-white/10">
              <img id="profileAvatar" src="" alt="Profile" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1">
              <h2 id="profileName" class="text-xl font-bold">—</h2>
              <p id="profileSpecialty" class="text-white/60 text-sm">—</p>
              <span id="profileDegree" class="inline-block mt-2 px-2 py-0.5 text-xs rounded-full bg-primary-500/20 text-primary-300 border border-primary-500/30">—</span>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-3 mt-6">
            <div class="stat-item">
              <div class="text-sm text-white/60">Courses</div>
              <div id="statCourses" class="text-xl font-semibold">—</div>
            </div>
            <div class="stat-item">
              <div class="text-sm text-white/60">Satisfaction</div>
              <div id="statSatisfaction" class="text-xl font-semibold">—</div>
            </div>
            <div class="stat-item">
              <div class="text-sm text-white/60">Rating</div>
              <div id="statRating" class="text-xl font-semibold">—</div>
            </div>
          </div>
        </div>

        <!-- Editable profile -->
        <div class="lg:col-span-2 glass-card p-6 rounded-3xl border border-white/10 shadow-glass animate-slideUp">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-xl bg-secondary-500/20 text-secondary-300">
                <i data-feather="user"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold">Profile Management</h3>
                <p class="text-sm text-white/60">Update your info and avatar</p>
              </div>
            </div>
            <button id="editToggle" class="px-3 py-2 rounded-lg glass hover:bg-white/10 transition-all flex items-center gap-2">
              <i data-feather="edit-3"></i>
              <span>Edit</span>
            </button>
          </div>

          <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="form-label">Full Name</label>
              <input id="fieldName" type="text" class="form-input" placeholder="Your name"/>
            </div>
            <div>
              <label class="form-label">Email</label>
              <input id="fieldEmail" type="email" class="form-input" placeholder="you@example.com"/>
            </div>
            <div>
              <label class="form-label">Phone</label>
              <input id="fieldPhone" type="tel" class="form-input" placeholder="+123456789"/>
            </div>
            <div>
              <label class="form-label">Degree</label>
              <select id="fieldDegree" class="form-select">
                <option value="">Select degree</option>
                <option value="PhD">PhD</option>
                <option value="Master">Master</option>
                <option value="Bachelor">Bachelor</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="form-label">Specialized Field</label>
              <input id="fieldSpecialty" type="text" class="form-input" placeholder="e.g., Algorithms, Data Science"/>
            </div>
            <div class="md:col-span-2">
              <label class="form-label">Username</label>
              <input id="fieldUsername" type="text" class="form-input" placeholder="username"/>
            </div>

            <div class="md:col-span-2 flex items-center gap-3">
              <input id="avatarInput" type="file" accept="image/*" class="hidden">
              <button type="button" id="uploadAvatarBtn" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-all flex items-center gap-2">
                <i data-feather="upload-cloud"></i>
                <span>Upload Avatar</span>
              </button>
              <span id="avatarStatus" class="text-sm text-white/60">No file selected</span>
            </div>

            <div class="md:col-span-2 flex justify-end gap-3">
              <button type="button" id="cancelEditBtn" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-all">Cancel</button>
              <button type="submit" class="px-5 py-2 rounded-lg bg-gradient-to-r from-primary-500 to-secondary-500 hover:from-primary-600 hover:to-secondary-600 font-semibold transition-all flex items-center gap-2">
                <i data-feather="check-circle"></i>
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </section>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="glass-card px-4 py-3 rounded-xl border border-white/10 flex items-center gap-3">
      <i id="toastIcon" data-feather="check-circle" class="w-5 h-5 text-emerald-400"></i>
      <span id="toastMsg" class="text-sm">Saved</span>
    </div>
  </div>
  <script>
    // Firebase config (same as your admin app)
const firebaseConfig = {
  apiKey: "AIzaSyCPV_mXojZBR-Dew8RuZSi9jv9X6rc_D90",
  authDomain: "mentora-71f5c.firebaseapp.com",
  projectId: "mentora-71f5c",
  storageBucket: "mentora-71f5c.appspot.com",
  messagingSenderId: "16685388211",
  appId: "1:16685388211:web:7eed812660439dec7b3bc6",
  measurementId: "G-BL98PXGK2G"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// State
let currentUser = null;
let teacherDocId = null;
let teacherData = null;
let avatarFileRef = null;

// UI refs
const authView = document.getElementById('authView');
const dashboardView = document.getElementById('dashboardView');

const loginIdentifier = document.getElementById('loginIdentifier');
const loginPassword = document.getElementById('loginPassword');
const togglePassword = document.getElementById('togglePassword');
const rememberMe = document.getElementById('rememberMe');
const loginBtn = document.getElementById('loginBtn');

const welcomeName = document.getElementById('welcomeName');
const welcomeMeta = document.getElementById('welcomeMeta');
const avatarInitial = document.getElementById('avatarInitial');

const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const profileSpecialty = document.getElementById('profileSpecialty');
const profileDegree = document.getElementById('profileDegree');

const statCourses = document.getElementById('statCourses');
const statSatisfaction = document.getElementById('statSatisfaction');
const statRating = document.getElementById('statRating');

const editToggle = document.getElementById('editToggle');
const profileForm = document.getElementById('profileForm');

const fieldName = document.getElementById('fieldName');
const fieldEmail = document.getElementById('fieldEmail');
const fieldPhone = document.getElementById('fieldPhone');
const fieldDegree = document.getElementById('fieldDegree');
const fieldSpecialty = document.getElementById('fieldSpecialty');
const fieldUsername = document.getElementById('fieldUsername');

const avatarInput = document.getElementById('avatarInput');
const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
const avatarStatus = document.getElementById('avatarStatus');

const cancelEditBtn = document.getElementById('cancelEditBtn');
const logoutBtn = document.getElementById('logoutBtn');

const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const toastIcon = document.getElementById('toastIcon');

const bubbles = document.getElementById('bubbles');

// Helpers
function showToast(message, type = 'success') {
  toastMsg.textContent = message;
  toastIcon.setAttribute('data-feather', type === 'success' ? 'check-circle' : 'alert-circle');
  toast.classList.remove('hidden');
  feather.replace();
  setTimeout(() => toast.classList.add('hidden'), 3000);
}

function switchView(to) {
  if (to === 'dashboard') {
    authView.classList.add('hidden');
    dashboardView.classList.remove('hidden');
  } else {
    dashboardView.classList.add('hidden');
    authView.classList.remove('hidden');
  }
}

function setFieldsDisabled(disabled) {
  [fieldName, fieldEmail, fieldPhone, fieldDegree, fieldSpecialty, fieldUsername].forEach(el => el.disabled = disabled);
}

function getClassIdFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('classId') || localStorage.getItem('currentClassId') || '';
}

function saveClassIdLocal(classId) {
  if (classId) localStorage.setItem('currentClassId', classId);
}

async function findTeacherDoc(uid, classId) {
  if (!uid || !classId) return null;
  // Try path: departments/<auto> -> classes/<classId> -> teachers where authUid == uid
  try {
    const deptSnap = await db.collection('departments').get();
    for (const deptDoc of deptSnap.docs) {
      const tSnap = await db.collection('departments').doc(deptDoc.id)
        .collection('classes').doc(classId)
        .collection('teachers').where('authUid', '==', uid).limit(1).get();
      if (!tSnap.empty) {
        const d = tSnap.docs[0];
        return { deptId: deptDoc.id, classId, id: d.id, ...d.data() };
      }
      // Fallback: scan by email match if authUid not set
      const tSnap2 = await db.collection('departments').doc(deptDoc.id)
        .collection('classes').doc(classId)
        .collection('teachers').get();
      for (const d of tSnap2.docs) {
        const data = d.data();
        if (data && data.email && currentUser && data.email.toLowerCase() === currentUser.email.toLowerCase()) {
          return { deptId: deptDoc.id, classId, id: d.id, ...data };
        }
      }
    }
  } catch (e) {
    console.warn('findTeacherDoc error', e);
  }
  return null;
}

async function updateProfileOnAuth() {
  if (!currentUser) return;
  try {
    await currentUser.updateProfile({ displayName: (fieldName.value || '').trim() });
  } catch {}
}

function randomStats() {
  const courses = Math.floor(Math.random() * 5) + 1;
  const satisfaction = Math.floor(Math.random() * 20) + 80; // 80-99
  const rating = Math.floor(Math.random() * 21) + 80; // 80-100
  return { courses, satisfaction, rating };
}

function setStats({ courses, satisfaction, rating }) {
  statCourses.textContent = courses;
  statSatisfaction.textContent = satisfaction + '%';
  statRating.textContent = rating;
}

function fillProfile(data = {}) {
  const name = data.name || currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Teacher';
  const email = data.email || currentUser?.email || '';
  const phone = data.phone || '';
  const degree = data.degree || '';
  const specialty = data.specialty || '';
  const username = data.username || '';
  const imageUrl = data.imageUrl || '';

  profileName.textContent = name;
  welcomeName.textContent = name.split(' ')[0] || 'Teacher';
  avatarInitial.textContent = (name || 'T').charAt(0).toUpperCase();
  welcomeMeta.textContent = [degree, specialty].filter(Boolean).join(' • ') || '—';

  profileSpecialty.textContent = specialty || '—';
  profileDegree.textContent = degree || '—';
  profileAvatar.src = imageUrl || 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=800&auto=format&fit=crop';

  fieldName.value = name;
  fieldEmail.value = email;
  fieldPhone.value = phone;
  fieldDegree.value = degree;
  fieldSpecialty.value = specialty;
  fieldUsername.value = username;

  const stats = randomStats();
  setStats(stats);

  setFieldsDisabled(true);
}

async function loadTeacher() {
  const classId = getClassIdFromURL();
  if (!classId) {
    showToast('Missing classId. Append ?classId=... to the URL', 'error');
    return;
  }
  saveClassIdLocal(classId);

  const found = await findTeacherDoc(currentUser.uid, classId);
  if (!found) {
    showToast('No profile found for this class. Ask admin to register you.', 'error');
    return;
  }
  teacherDocId = found.id;
  teacherData = found;
  fillProfile(found);
  switchView('dashboard');
}

function setLoading(btn, loading) {
  if (!btn) return;
  if (loading) {
    btn.dataset.original = btn.innerHTML;
    btn.innerHTML = '<span class="inline-flex items-center gap-2"><span class="w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin"></span>Signing in...</span>';
    btn.disabled = true;
  } else if (btn.dataset.original) {
    btn.innerHTML = btn.dataset.original;
    btn.disabled = false;
  }
}

// Events
togglePassword.addEventListener('click', () => {
  const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
  loginPassword.setAttribute('type', type);
  const icon = togglePassword.querySelector('i');
  icon.setAttribute('data-feather', type === 'password' ? 'eye' : 'eye-off');
  feather.replace();
});

loginBtn.addEventListener('click', async () => {
  const id = (loginIdentifier.value || '').trim();
  const pw = (loginPassword.value || '').trim();
  if (!id || !pw) {
    showToast('Please enter your email/username and password.', 'error');
    return;
  }
  setLoading(loginBtn, true);

  try {
    // Decide if id is an email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const email = emailRegex.test(id) ? id : `${id}@example.com`; // fallback
    await auth.signInWithEmailAndPassword(email, pw);
    currentUser = auth.currentUser;
    if (rememberMe.checked) localStorage.setItem('remembered', id);
    showToast('Welcome back!');
    await loadTeacher();
  } catch (err) {
    console.error(err);
    let msg = 'Login failed. Check your credentials.';
    if (err?.code === 'auth/user-not-found') msg = 'No user found for this email.';
    if (err?.code === 'auth/wrong-password') msg = 'Incorrect password.';
    showToast(msg, 'error');
  } finally {
    setLoading(loginBtn, false);
  }
});

logoutBtn.addEventListener('click', async () => {
  await auth.signOut();
  currentUser = null;
  teacherData = null;
  teacherDocId = null;
  switchView('auth');
  showToast('Signed out.');
});

editToggle.addEventListener('click', () => {
  const isDisabled = fieldName.disabled;
  setFieldsDisabled(!isDisabled);
  if (!isDisabled) {
    // entering view mode
    editToggle.querySelector('span').textContent = 'Edit';
    editToggle.querySelector('i').setAttribute('data-feather', 'edit-3');
    feather.replace();
  } else {
    editToggle.querySelector('span').textContent = 'Editing';
    editToggle.querySelector('i').setAttribute('data-feather', 'save');
    feather.replace();
  }
});

cancelEditBtn.addEventListener('click', () => {
  fillProfile(teacherData);
});

profileForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const classId = getClassIdFromURL();
  if (!teacherDocId || !classId) {
    showToast('Profile not ready. Try logging in again.', 'error');
    return;
  }
  const deptId = (teacherData && teacherData.deptId) || null;
  if (!deptId) {
    showToast('Missing department context.', 'error');
    return;
  }

  const updated = {
    name: (fieldName.value || '').trim(),
    email: (fieldEmail.value || '').trim(),
    phone: (fieldPhone.value || '').trim(),
    degree: (fieldDegree.value || '').trim(),
    specialty: (fieldSpecialty.value || '').trim(),
    username: (fieldUsername.value || '').trim(),
  };

  try {
    // If email changed, attempt to update auth email
    if (updated.email && updated.email.toLowerCase() !== (currentUser?.email || '').toLowerCase()) {
      try {
        await currentUser.updateEmail(updated.email);
      } catch (e2) {
        // If updateEmail fails (e.g., not verified), we still save in Firestore
        console.warn('updateEmail failed:', e2);
      }
    }
    await currentUser.updateProfile({ displayName: updated.name });

    await db.collection('departments').doc(deptId)
      .collection('classes').doc(classId)
      .collection('teachers').doc(teacherDocId)
      .update({
        ...updated,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

    teacherData = { ...teacherData, ...updated };
    fillProfile(teacherData);
    showToast('Profile updated!');
    setFieldsDisabled(true);
    editToggle.querySelector('span').textContent = 'Edit';
    editToggle.querySelector('i').setAttribute('data-feather', 'edit-3');
    feather.replace();
  } catch (err) {
    console.error(err);
    showToast('Failed to update profile.', 'error');
  }
});

uploadAvatarBtn.addEventListener('click', () => avatarInput.click());
avatarInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) {
    avatarStatus.textContent = 'No file selected';
    avatarFileRef = null;
    return;
  }
  if (!file.type.startsWith('image/')) {
    showToast('Please select an image file.', 'error');
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    showToast('Image must be less than 2MB.', 'error');
    return;
  }
  avatarStatus.textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
  avatarFileRef = file;
});

profileAvatar.addEventListener('click', () => avatarInput.click());

async function uploadAvatarIfNeeded() {
  if (!avatarFileRef || !teacherDocId) return;
  const classId = getClassIdFromURL();
  const deptId = teacherData?.deptId;
  if (!deptId || !classId) return;

  try {
    const reader = new FileReader();
    const dataUrl = await new Promise((resolve) => {
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(avatarFileRef);
    });
    await db.collection('departments').doc(deptId)
      .collection('classes').doc(classId)
      .collection('teachers').doc(teacherDocId)
      .update({
        imageUrl: dataUrl,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    profileAvatar.src = dataUrl;
    teacherData.imageUrl = dataUrl;
    avatarFileRef = null;
    avatarStatus.textContent = 'Avatar updated';
    showToast('Avatar updated!');
  } catch (e) {
    console.error(e);
    showToast('Failed to upload avatar.', 'error');
  }
}

// Auto-call upload avatar after profile save
profileForm.addEventListener('submit', uploadAvatarIfNeeded, { once: true });

// Auth state
auth.onAuthStateChanged(async (user) => {
  currentUser = user;
  if (user) {
    await loadTeacher();
  } else {
    switchView('auth');
  }
});

// Startup
document.addEventListener('DOMContentLoaded', () => {
  feather.replace();
  const remembered = localStorage.getItem('remembered');
  if (remembered) {
    loginIdentifier.value = remembered;
    rememberMe.checked = true;
  }
  generateBubbles();
});

// Bubbles background
function generateBubbles() {
  const count = 26;
  bubbles.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const b = document.createElement('span');
    b.className = 'bubble';
    const size = Math.random() * 70 + 30; // 30-100px
    const left = Math.random() * 100;
    const duration = 18 + Math.random() * 14;
    const dx = (Math.random() * 120 - 60) + 'px';
    b.style.width = size + 'px';
    b.style.height = size + 'px';
    b.style.left = left + 'vw';
    b.style.setProperty('--t', duration + 's');
    b.style.setProperty('--dx', dx);
    bubbles.appendChild(b);
  }
}
  </script>
</body>
</html>